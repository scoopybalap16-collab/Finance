<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catatan Hutang Piutang</title>
    
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script> 
<style>
    /* ---------------------------------- */
    /* GAYA UMUM & MOBILE FIRST */
    /* ---------------------------------- */
    :root {
        --primary-color: #007bff; /* Biru cerah */
        --success-color: #28a745; /* Hijau */
        --danger-color: #dc3545; /* Merah */
        --warning-color: #ffc107; /* Kuning */
        --light-bg: #f8f9fa; /* Background halaman */
        --card-bg: #ffffff; /* Background kartu */
        --text-dark: #343a40; /* Teks gelap */
        --text-muted: #6c757d; /* Teks redup */
        --border-color: #dee2e6;
        --shadow-elevation: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    
    body { 
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        margin: 0; 
        background-color: var(--light-bg); 
        display: flex; 
        flex-direction: column; 
        min-height: 100vh; 
        height: 100vh; 
        overflow: hidden; 
        color: var(--text-dark);
    }
    
    /* PERUBAHAN DI SINI: MENGURANGI PADDING HEADER LAGI */
    .header { 
        background-color: var(--primary-color); 
        color: white; 
        padding: 6px 15px; /* DARI 12px MENJADI 6px */
        text-align: center; 
        box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
        font-size: 1.1em;
        position: relative; 
        flex-shrink: 0; 
    }
    
    /* PERUBAHAN DI SINI: MENGECEILKAN UKURAN TEXT H1 */
    .header h1 {
        font-size: 1.2em; /* Mengurangi ukuran teks */
        margin: 0; /* Menghilangkan margin bawaan h1 */
    }

    #menuToggle {
        position: absolute; 
        left: 15px; 
        top: 50%; 
        transform: translateY(-50%); 
        font-size: 1.5em; 
        cursor: pointer;
        color: white;
        padding: 5px;
        line-height: 1;
    }
    
    .container { 
        max-width: 450px; 
        width: 100%; 
        margin: 0 auto; 
        background: var(--card-bg); 
        padding: 15px; 
        flex-grow: 1; 
        overflow-y: scroll; 
        -webkit-overflow-scrolling: touch; 
        padding-bottom: 20px; 
        box-sizing: border-box;
    }
    .page { display: none; padding-top: 5px; } 
    .page.active { display: block; }
    
    h2 { 
        border-bottom: 2px solid var(--border-color); 
        padding-bottom: 10px; 
        color: var(--text-dark); 
        margin-top: 15px; 
        font-size: 1.4em; 
        font-weight: 600;
        margin-bottom: 20px; 
    } 
    h3 {
         font-size: 1.1em;
         color: var(--text-dark);
         margin-top: 25px;
         margin-bottom: 15px;
         font-weight: 600;
    }
    
    /* ---------------------------------- */
    /* GAYA MENU SAMPING BARU (TETAP) */
    /* ---------------------------------- */
    #sideMenuModal {
        display: none; 
        position: fixed; 
        z-index: 1001; 
        left: 0; 
        top: 0; 
        width: 100%; 
        height: 100%; 
        background-color: rgba(0,0,0,0.5); 
    }
    #sideMenuContent {
        width: 75%; 
        max-width: 300px; 
        height: 100%; 
        background-color: var(--card-bg); 
        padding: 20px 0; 
        box-shadow: 4px 0 12px rgba(0,0,0,0.15);
        transform: translateX(-100%); 
        transition: transform 0.3s ease-out;
    }
    .menu-item {
        padding: 12px 20px;
        cursor: pointer;
        font-size: 1.0em;
        font-weight: 500;
        color: var(--text-dark);
        transition: background-color 0.2s, color 0.2s;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .menu-item:hover, .menu-item.active {
        background-color: var(--light-bg);
        color: var(--primary-color);
    }
    .menu-item.active {
        border-left: 5px solid var(--primary-color);
        padding-left: 15px; 
        font-weight: 600;
    }

    /* ---------------------------------- */
    /* GAYA DASHBOARD & CARD (TETAP) */
    /* ---------------------------------- */
    #mainDashboard { display: flex; flex-wrap: wrap; justify-content: space-between; margin-bottom: 20px; }
    .summary-card { 
        flex-basis: 100%; 
        padding: 15px; 
        border-radius: 12px; 
        text-align: left; 
        margin-bottom: 12px; 
        box-shadow: var(--shadow-elevation);
        transition: all 0.3s;
    }
    .summary-card h3 { 
        margin-top: 0; 
        font-size: 0.9em; 
        color: var(--text-dark); 
        font-weight: 500;
        margin-bottom: 5px;
    } 
    .summary-card p { 
        font-size: 1.4em; 
        font-weight: bold; 
        margin: 0; 
    } 
    .card-piutang { background-color: #e6f7ef; border-left: 5px solid var(--success-color); } 
    .card-utang { background-color: #fcebeb; border-left: 5px solid var(--danger-color); } 
    .card-networth { background-color: #fff8e1; border-left: 5px solid var(--warning-color); font-size: 1.1em; }
    
    /* Layout kolom untuk mobile */
    @media (min-width: 350px) {
        .summary-card { flex-basis: 48%; }
        .card-networth { flex-basis: 100%; margin-top: 5px; }
    }
    
    /* ---------------------------------- */
    /* GAYA LIST TRANSAKSI (TETAP) */
    /* ---------------------------------- */
    .transaction-list-container {
        border: none; 
        padding: 0; 
        border-radius: 0; 
        background-color: var(--light-bg);
    }
    
    .transaction-list-item {
        display: flex;
        align-items: center;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 10px;
        background-color: var(--card-bg);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        cursor: pointer;
        transition: transform 0.1s, box-shadow 0.1s;
    }
    .transaction-list-item:active {
        transform: scale(0.98);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .avatar-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #e9ecef;
        color: var(--primary-color);
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.4em;
        font-weight: 600;
        margin-right: 15px;
        flex-shrink: 0;
    }
    .info-section { flex-grow: 1; min-width: 0; }
    .info-section strong { font-size: 1.1em; color: var(--text-dark); }
    .info-section p { font-size: 0.8em; }
    
    .status-badge {
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 0.7em;
        font-weight: 600;
        margin-right: 5px;
    }
    .status-active { background-color: #d1ecf1; color: #008080; } 
    .status-late { background-color: #f8d7da; color: var(--danger-color); } 
    
    .amount-section { text-align: right; flex-shrink: 0; margin-left: 10px; }
    .amount-section .remaining-amount { font-size: 1.2em; font-weight: bold; color: var(--success-color); }
    .transaction-list-item.utang .amount-section .remaining-amount { color: var(--danger-color); }
    .amount-section .due-info { font-size: 0.75em; color: var(--text-muted); margin-top: 2px; }

    /* ---------------------------------- */
    /* GAYA FORM & CONTROLS (TETAP) */
    /* ---------------------------------- */
    .controls-container {
        margin-bottom: 15px;
        padding: 10px 0;
        border-bottom: 1px solid var(--border-color);
    }
    .search-container input {
        width: 100%;
        padding: 10px 15px;
        border: 1px solid var(--border-color);
        border-radius: 25px;
        box-sizing: border-box;
        font-size: 1em;
        margin-bottom: 10px;
        transition: border-color 0.3s;
    }
    .search-container input:focus {
        border-color: var(--primary-color);
        outline: none;
    }
    
    .sort-controls {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.9em;
        color: var(--text-muted);
    }
    .sort-controls select {
        padding: 8px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 0.9em;
        background-color: white;
    }
    
    label {
         display: block;
         margin-bottom: 5px;
         font-weight: 500;
         color: var(--text-dark);
         font-size: 0.95em;
    }

    input[type="text"], input[type="number"], input[type="date"], select { 
        width: 100%; 
        padding: 12px; 
        border: 1px solid var(--border-color); 
        border-radius: 8px; 
        box-sizing: border-box; 
        font-size: 1em; 
        margin-bottom: 15px;
        background-color: var(--light-bg);
    }
    
    button { 
        padding: 12px 18px; 
        background-color: var(--primary-color); 
        color: white; 
        border: none; 
        border-radius: 8px; 
        cursor: pointer; 
        margin-top: 10px;
        font-size: 1em; 
        font-weight: 600;
        transition: background-color 0.2s;
    }
    button:hover {
         background-color: #0056b3;
    }
    
    /* Gaya untuk tombol Aksi di Modal */
    #modalActions button {
        width: 100%;
        margin-bottom: 8px;
        padding: 10px;
    }

    /* ---------------------------------- */
    /* GAYA MODAL (TETAP) */
    /* ---------------------------------- */
    .modal-detail-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        border-bottom: 1px dotted var(--border-color);
        padding-bottom: 5px;
        font-size: 0.95em;
    }
    #modalContent .payment-history-list {
        max-height: 150px;
        overflow-y: auto;
        padding: 5px;
        border: 1px solid #eee;
        border-radius: 5px;
    }
    #modalContent .payment-history-list div {
        display: flex;
        justify-content: space-between;
        padding: 5px 0;
        border-bottom: 1px dotted #f1f1f1;
        font-size: 0.85em;
    }
</style>
</head>
<body>

    <div class="header">
        <div id="menuToggle">‚ò∞</div>
        <h1>Catatan Hutang Piutang</h1>
    </div>
    
    <div id="sideMenuModal">
        <div id="sideMenuContent">
            <h3 style="padding: 0 20px;">Menu Aplikasi</h3>
            <hr style="margin-bottom: 20px;">
            <div class="menu-item active" data-page="homePage">üè† Beranda</div>
            <div class="menu-item" data-page="piutangPage">‚úÖ Piutang</div>
            <div class="menu-item" data-page="utangPage">‚ùå Utang</div>
            <div class="menu-item" data-page="historyPage">üìú Riwayat</div>
            <div class="menu-item" data-page="summaryPage">üëë Ringkasan & Export</div>
            <div class="menu-item" data-page="formPage">‚ûï Tambah Transaksi</div>
        </div>
    </div>
    <div class="container">
        
        <div id="homePage" class="page active">
            <h2>Beranda üìä</h2>
            <div id="mainDashboard"></div>
            
            <h3 style="margin-top: 25px;">Status Keuangan (Grafik) üìà</h3>
            <div id="chartArea" style="height: 250px; background-color: white; padding: 10px; border-radius: 12px; box-shadow: var(--shadow-elevation); margin-bottom: 20px;">
                <canvas id="piutangChart"></canvas>
            </div>
            
            <h3>Transaksi Aktif Terbaru</h3>
            <div id="latestTransactions" class="transaction-list-container">
                <p style="text-align: center; color: var(--text-muted);">Memuat data...</p>
            </div>
        </div>
        
        <div id="formPage" class="page">
            <h2>Tambah Transaksi Baru ‚ûï</h2>
            <form id="transactionForm">
                <div><label for="type">Tipe Transaksi:</label><select id="type" required><option value="piutang">Piutang (Saya Memberi Pinjaman)</option><option value="utang">Utang (Saya Menerima Pinjaman)</option></select></div>
                <div><label for="person">Nama Pihak/Orang:</label><input type="text" id="person" required></div>
                <div><label for="principal">Jumlah Pokok (Rp):</label><input type="text" id="principal" required onkeyup="formatInputRupiah(this); updateInstallmentEstimate()"></div>
                
                <div><label for="startDate">Tanggal Mulai Pinjam:</label><input type="date" id="startDate" required onchange="calculateDueDate()"></div>
                
                <div><label for="interestRate">Suku Bunga (% per Bulan):</label><input type="text" id="interestRate" min="0" value="0" required onkeyup="updateInstallmentEstimate()"></div>
                <div><label for="installmentsCount">Tenor/Jumlah Cicilan (Bulan):</label><input type="number" id="installmentsCount" min="1" value="1" required onchange="updateInstallmentEstimate(); calculateDueDate()"></div>
                <div id="installmentEstimate" style="padding: 10px; background-color: #e3f2fd; border: 1px solid #bbdefb; border-radius: 8px; margin-bottom: 15px; display: none;"></div>
                
                <div><label>Tanggal Jatuh Tempo Terakhir:</label><p id="finalDueDateDisplay" style="padding: 12px; border: 1px solid #ddd; background-color: #f8f8f8; border-radius: 8px; margin-top: 0;"></p></div>
                
                <button type="submit" style="width: 100%;">Catat Transaksi</button>
            </form>
        </div>

        <div id="piutangPage" class="page">
            <h2>Daftar Piutang Aktif ‚úÖ</h2>
            <div class="controls-container">
                <div class="search-container"><input type="text" id="searchPiutang" placeholder="Cari Piutang berdasarkan nama..." onkeyup="filterTransactionList('piutang')"></div>
                <div class="sort-controls">
                    <label for="sortPiutang">Urutkan:</label>
                    <select id="sortPiutang" onchange="filterTransactionList('piutang')">
                        <option value="due_asc">Jatuh Tempo Terdekat</option>
                        <option value="due_desc">Jatuh Tempo Terlama</option>
                        <option value="amount_desc">Sisa (Terbesar)</option>
                    </select>
                </div>
            </div>
            <div id="piutangList" class="transaction-list-container"><p>Memuat data piutang...</p></div>
        </div>

        <div id="utangPage" class="page">
            <h2>Daftar Utang Aktif ‚ùå</h2>
            <div class="controls-container">
                <div class="search-container"><input type="text" id="searchUtang" placeholder="Cari Utang berdasarkan nama..." onkeyup="filterTransactionList('utang')"></div>
                <div class="sort-controls">
                    <label for="sortUtang">Urutkan:</label>
                    <select id="sortUtang" onchange="filterTransactionList('utang')">
                        <option value="due_asc">Jatuh Tempo Terdekat</option>
                        <option value="due_desc">Jatuh Tempo Terlama</option>
                        <option value="amount_desc">Sisa (Terbesar)</option>
                    </select>
                </div>
            </div>
            <div id="utangList" class="transaction-list-container"><p>Memuat data utang...</p></div>
        </div>
        
        <div id="historyPage" class="page">
            <h2>Riwayat Transaksi Lunas üìú</h2>
            <div class="controls-container">
                <div class="search-container"><input type="text" id="searchHistory" placeholder="Cari Riwayat berdasarkan nama..." onkeyup="filterTransactionList('history')"></div>
                <div class="sort-controls">
                    <label for="sortHistory">Urutkan:</label>
                    <select id="sortHistory" onchange="filterTransactionList('history')">
                        <option value="lunas_desc">Tanggal Lunas Terbaru</option>
                        <option value="principal_desc">Pokok (Terbesar)</option>
                    </select>
                </div>
            </div>
            <div id="historyList" class="transaction-list-container"><p>Memuat riwayat lunas...</p></div>
        </div>

        <div id="summaryPage" class="page">
            <h2>Ringkasan & Export Data üëë</h2>
            
            <div style="background-color: #e9ecef; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                <p style="margin-top:0;">Export data transaksi aktif dan lunas ke dalam format CSV (kompatibel dengan Excel) untuk analisis lebih lanjut.</p>
                <button onclick="exportToCSV()" style="background-color: var(--success-color); width: 100%;">Export Semua Data ke CSV</button>
            </div>

            
            <h3>Ringkasan Saldo Global</h3>
            <div id="balanceSummary" style="border: 1px solid var(--border-color); padding: 15px; border-radius: 12px; background-color: var(--card-bg);">
                <div class="modal-detail-row"><span>Total Piutang (Awal):</span> <strong id="summaryPiutangAwal">Rp 0</strong></div>
                <div class="modal-detail-row"><span>Sisa Piutang (Aktif):</span> <strong id="summaryPiutangSisa">Rp 0</strong></div>
                <hr style="border: none; border-top: 1px dashed #eee; margin: 10px 0;">
                <div class="modal-detail-row"><span>Total Utang (Awal):</span> <strong id="summaryUtangAwal">Rp 0</strong></div>
                <div class="modal-detail-row"><span>Sisa Utang (Aktif):</span> <strong id="summaryUtangSisa">Rp 0</strong></div>
                <hr style="border: none; border-top: 2px solid var(--border-color); margin: 15px 0;">
                <div class="modal-detail-row" style="font-size: 1.1em; font-weight: bold; padding-bottom: 0; border-bottom: none;"><span>Net Worth (Bersih Aktif):</span> <strong id="summaryNetWorth">Rp 0</strong></div>
            </div>
        </div>

    </div>

    <div id="transactionDetailModal" style="
        display: none; 
        position: fixed; 
        z-index: 1000; 
        left: 0; 
        top: 0; 
        width: 100%; 
        height: 100%; 
        overflow: auto; 
        background-color: rgba(0,0,0,0.6); 
    ">
        <div style="
            background-color: var(--card-bg);
            margin: 10% auto; 
            padding: 20px;
            border: 1px solid #888;
            width: 90%; 
            max-width: 400px;
            border-radius: 12px;
            box-shadow: var(--shadow-elevation);
        ">
            <span onclick="closeDetailModal()" style="
                color: #aaa; 
                float: right; 
                font-size: 32px; 
                font-weight: bold;
                cursor: pointer;
            ">&times;</span>
            <h3 id="modalTitle" style="margin-top: 0; padding-bottom: 10px; border-bottom: 2px solid var(--border-color);">Detail Transaksi</h3>
            <div id="modalContent">
                </div>
            <div id="modalActions" style="margin-top: 15px;">
                </div>
        </div>
    </div>
    <script>
    let transactions = [];
    const form = document.getElementById('transactionForm');
    const piutangListContainer = document.getElementById('piutangList');
    const utangListContainer = document.getElementById('utangList');
    const historyListContainer = document.getElementById('historyList'); 
    
    // VARIABEL BARU UNTUK MENU SAMPING
    const menuToggle = document.getElementById('menuToggle');
    const sideMenuModal = document.getElementById('sideMenuModal');
    const sideMenuContent = document.getElementById('sideMenuContent');
    const menuItems = document.querySelectorAll('#sideMenuModal .menu-item');

    const principalInput = document.getElementById('principal');
    const interestRateInput = document.getElementById('interestRate');
    const installmentsCountInput = document.getElementById('installmentsCount');
    const startDateInput = document.getElementById('startDate'); 
    const finalDueDateDisplay = document.getElementById('finalDueDateDisplay'); 
    const estimateDiv = document.getElementById('installmentEstimate');

    let piutangChartInstance = null; 

    // ===================================
    // 1. MANAJEMEN DATA & LOCAL STORAGE (TETAP)
    // ===================================

    function loadTransactions() {
        const storedTransactions = localStorage.getItem('personalFinanceTracker');
        if (storedTransactions) {
            transactions = JSON.parse(storedTransactions); 
        }
    }

    function saveTransactions() {
        localStorage.setItem('personalFinanceTracker', JSON.stringify(transactions));
    }
    
    // ===================================
    // 2. FUNGSI UTILITAS (TETAP)
    // ===================================

    function formatInputRupiah(inputElement) {
        let angka = inputElement.value.replace(/\D/g, ''); 
        if (!angka || angka === '0') {
            inputElement.value = '';
            return;
        }
        let formatted = new Intl.NumberFormat('id-ID').format(angka);
        inputElement.value = formatted;
    }

    function formatCurrency(amount) {
        const roundedAmount = Math.round(parseFloat(amount)); 
        return roundedAmount.toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    }
    
    function cleanInterestRate(input) {
        return input.replace(/,/g, '.').replace(/[^0-9.]/g, ''); 
    }
    
    function cleanPrincipal(input) {
         return input.replace(/\./g, ''); 
    }

    function calculateTotal(principal, rate, installmentsCount) {
        const principalAmount = parseFloat(principal); 
        const interestRate = parseFloat(rate) / 100; 
        const installments = parseInt(installmentsCount);
        
        if (isNaN(principalAmount) || isNaN(interestRate) || isNaN(installments) || installments === 0) {
            return { totalInterest: 0, totalAmount: 0, totalPerInstallment: 0 };
        }
        
        const totalInterest = principalAmount * interestRate * installments;
        const totalAmount = principalAmount + totalInterest;
        const totalPerInstallment = totalAmount / installments;
        
        return {
            totalInterest: totalInterest,
            totalAmount: totalAmount,
            totalPerInstallment: totalPerInstallment,
        };
    }
    
    function getFinancialTotals() {
        let totalPiutangAwal = 0; 
        let sisaPiutang = 0;      
        let totalUtangAwal = 0;   
        let sisaUtang = 0;        

        const activeTransactions = transactions.filter(tx => tx.status === 'aktif');

        activeTransactions.forEach(tx => {
            const result = calculateTotal(tx.principal, tx.interestRate, tx.installmentsCount);
            const paidCount = tx.paymentHistory ? tx.paymentHistory.length : 0;
            const remainingInstallments = tx.installmentsCount - paidCount;
            const remainingTotal = result.totalPerInstallment * remainingInstallments;

            if (tx.type === 'piutang') {
                totalPiutangAwal += result.totalAmount; 
                sisaPiutang += remainingTotal;      
            } else if (tx.type === 'utang') {
                totalUtangAwal += result.totalAmount;   
                sisaUtang += remainingTotal;        
            }
        });
        
        const netWorthAwal = totalPiutangAwal - totalUtangAwal;
        const netWorthAkhir = sisaPiutang - sisaUtang;
        
        return {
            totalPiutangAwal, sisaPiutang, 
            totalUtangAwal, sisaUtang,
            netWorthAwal, netWorthAkhir
        };
    }
    
    function updateInstallmentEstimate() {
        const principalFormatted = principalInput.value;
        const principalClean = cleanPrincipal(principalFormatted); 
        const rateClean = cleanInterestRate(interestRateInput.value); 
        const installments = parseInt(installmentsCountInput.value);

        if (!principalClean || !rateClean || installments < 1) {
            estimateDiv.style.display = 'none';
            return;
        }

        const result = calculateTotal(principalClean, rateClean, installments);

        if (result.totalPerInstallment > 0) {
            estimateDiv.style.display = 'block';
            estimateDiv.innerHTML = `
                <p style="margin: 0; font-size: 0.9em; color:#0056b3;">
                    Estimasi Cicilan per Bulan (${installments}x): 
                    <strong style="font-size: 1.1em;">Rp ${formatCurrency(result.totalPerInstallment)}</strong>
                    <span style="font-size: 0.8em; color: #555;">(Total akhir: Rp ${formatCurrency(result.totalAmount)})</span>
                </p>
            `;
        } else {
             estimateDiv.style.display = 'none';
        }
    }
    
    function calculateDueDate() {
        const startDateValue = startDateInput.value;
        const installments = parseInt(installmentsCountInput.value);
        
        if (!startDateValue || installments < 1) {
            finalDueDateDisplay.textContent = 'Pilih tanggal mulai dan tenor/cicilan.';
            return '';
        }

        const startDate = new Date(startDateValue);
        if (isNaN(startDate)) {
            finalDueDateDisplay.textContent = 'Tanggal mulai tidak valid.';
            return '';
        }
        
        const finalDueDate = new Date(startDate);
        finalDueDate.setMonth(finalDueDate.getMonth() + installments); 

        const formattedDate = finalDueDate.toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });
        
        finalDueDateDisplay.textContent = formattedDate;
        
        return finalDueDate.toISOString().split('T')[0];
    }
    
    function calculateNextDueDate(tx) {
         const dateString = tx.startDate || tx.date;
         
         if (tx.status !== 'aktif' || !dateString) return null;

         const paidCount = tx.paymentHistory ? tx.paymentHistory.length : 0;
         if (paidCount >= tx.installmentsCount) return null; 

         const startDate = new Date(dateString); 
         
         // Hitung tanggal jatuh tempo cicilan berikutnya
         const nextDueDate = new Date(startDate);
         nextDueDate.setMonth(nextDueDate.getMonth() + paidCount + 1); 

         return nextDueDate.toISOString().split('T')[0]; 
    }
    
    function getDueStatus(dueDate) {
        if (!dueDate) return { badge: '', class: '' }; 

        const today = new Date();
        today.setHours(0, 0, 0, 0); 
        
        const due = new Date(dueDate);
        due.setHours(0, 0, 0, 0); 

        const diffTime = due - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays < 0) {
            return { badge: `TERLAMBAT ${Math.abs(diffDays)} hari`, class: 'status-late' };
        } else if (diffDays <= 7) {
            return { badge: `JATUH TEMPO ${diffDays} hari lagi`, class: 'status-active' };
        } else {
            return { badge: 'AKTIF', class: 'status-active' };
        }
    }

    // ===================================
    // 3. FUNGSI RENDER (TETAP)
    // ===================================
    
    function renderSummaryCards() {
        const totals = getFinancialTotals();
        const mainDashboard = document.getElementById('mainDashboard');
        mainDashboard.innerHTML = `
            <div class="summary-card card-piutang">
                <h3>Sisa Piutang Aktif</h3>
                <p>Rp ${formatCurrency(totals.sisaPiutang)}</p>
            </div>
            <div class="summary-card card-utang">
                <h3>Sisa Utang Aktif</h3>
                <p>Rp ${formatCurrency(totals.sisaUtang)}</p>
            </div>
            <div class="summary-card card-networth">
                <h3>Net Worth (Bersih)</h3>
                <p style="color: ${totals.netWorthAkhir >= 0 ? 'var(--success-color)' : 'var(--danger-color)'};">Rp ${formatCurrency(totals.netWorthAkhir)}</p>
            </div>
        `;

        // Update Summary Page
        document.getElementById('summaryPiutangAwal').textContent = `Rp ${formatCurrency(totals.totalPiutangAwal)}`;
        document.getElementById('summaryPiutangSisa').textContent = `Rp ${formatCurrency(totals.sisaPiutang)}`;
        document.getElementById('summaryUtangAwal').textContent = `Rp ${formatCurrency(totals.totalUtangAwal)}`;
        document.getElementById('summaryUtangSisa').textContent = `Rp ${formatCurrency(totals.sisaUtang)}`;
        document.getElementById('summaryNetWorth').textContent = `Rp ${formatCurrency(totals.netWorthAkhir)}`;
        document.getElementById('summaryNetWorth').style.color = totals.netWorthAkhir >= 0 ? 'var(--success-color)' : 'var(--danger-color)';
    }

    function renderTransactionList(type, containerId) {
        const container = document.getElementById(containerId);
        let listHtml = '';
        
        let filteredList;
        if (type === 'history') {
             filteredList = transactions.filter(tx => tx.status === 'lunas');
        } else {
             filteredList = transactions.filter(tx => tx.type === type && tx.status === 'aktif');
        }
        
        const searchQuery = document.getElementById(`search${type.charAt(0).toUpperCase() + type.slice(1)}`)?.value.toLowerCase() || '';
        if (searchQuery) {
            filteredList = filteredList.filter(tx => tx.person.toLowerCase().includes(searchQuery));
        }
        
        // Sorting
        const sortValue = document.getElementById(`sort${type.charAt(0).toUpperCase() + type.slice(1)}`)?.value;
        if (sortValue) {
            filteredList.sort((a, b) => sortTransactions(a, b, sortValue));
        } else if (type === 'history') {
            filteredList.sort((a, b) => new Date(b.dateCompleted) - new Date(a.dateCompleted)); // Default history sort
        } else {
             filteredList.sort((a, b) => { // Default active sort: due_asc
                const nextDueA = calculateNextDueDate(a) || '9999-12-31';
                const nextDueB = calculateNextDueDate(b) || '9999-12-31';
                return nextDueA.localeCompare(nextDueB);
            });
        }


        if (filteredList.length === 0) {
             container.innerHTML = `<p style="text-align: center; color: var(--text-muted);">Tidak ada ${type} ${type === 'history' ? 'yang lunas' : 'aktif'} yang tercatat.</p>`;
             return;
        }

        filteredList.forEach(tx => {
            const nextDueDate = calculateNextDueDate(tx);
            const dueStatus = getDueStatus(nextDueDate);
            const totals = calculateTotal(tx.principal, tx.interestRate, tx.installmentsCount);
            const paidCount = tx.paymentHistory ? tx.paymentHistory.length : 0;
            const remainingInstallments = tx.installmentsCount - paidCount;
            const remainingTotal = totals.totalPerInstallment * remainingInstallments;
            
            let amountDisplay;
            let dueInfo;
            let badge;

            if (tx.status === 'aktif') {
                amountDisplay = `<div class="remaining-amount">Rp ${formatCurrency(remainingTotal)}</div>`;
                dueInfo = `<div class="due-info">Cicilan ke ${paidCount + 1} (${tx.installmentsCount}x)</div>
                           <div class="due-info">Jatuh Tempo: ${nextDueDate ? new Date(nextDueDate).toLocaleDateString('id-ID') : '-'}</div>`;
                badge = `<span class="status-badge ${dueStatus.class}">${dueStatus.badge}</span>`;
            } else { // Lunas
                amountDisplay = `<div class="remaining-amount" style="color:var(--success-color);">LUNAS</div>`;
                dueInfo = `<div class="due-info">Pokok: Rp ${formatCurrency(tx.principal)}</div>
                           <div class="due-info">Lunas: ${tx.dateCompleted ? new Date(tx.dateCompleted).toLocaleDateString('id-ID') : '-'}</div>`;
                badge = `<span class="status-badge" style="background-color: #d4edda; color: var(--success-color);">SELESAI</span>`;
            }
            
            const initials = tx.person.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);

            listHtml += `
                <div class="transaction-list-item ${tx.type}" data-id="${tx.id}" onclick="showDetailModal('${tx.id}')">
                    <div class="avatar-icon">${initials}</div>
                    <div class="info-section">
                        <strong>${tx.person}</strong>
                        <p style="margin: 3px 0 0;">${tx.type === 'piutang' ? 'MEMBERI PINJAMAN' : 'MENERIMA PINJAMAN'}</p>
                        ${badge}
                    </div>
                    <div class="amount-section">
                        ${amountDisplay}
                        ${dueInfo}
                    </div>
                </div>
            `;
        });

        container.innerHTML = listHtml;
    }
    
    function renderLatestTransactions() {
        const latestContainer = document.getElementById('latestTransactions');
        let activeList = transactions.filter(tx => tx.status === 'aktif');
        
        // Sort by next due date (ascending)
        activeList.sort((a, b) => {
             const nextDueA = calculateNextDueDate(a) || '9999-12-31';
             const nextDueB = calculateNextDueDate(b) || '9999-12-31';
             return nextDueA.localeCompare(nextDueB);
        });
        
        const limitedList = activeList.slice(0, 5); // Ambil 5 transaksi terbaru

        if (limitedList.length === 0) {
             latestContainer.innerHTML = `<p style="text-align: center; color: var(--text-muted);">Tidak ada transaksi aktif.</p>`;
             return;
        }
        
        let listHtml = '';
        limitedList.forEach(tx => {
            const nextDueDate = calculateNextDueDate(tx);
            const dueStatus = getDueStatus(nextDueDate);
            const totals = calculateTotal(tx.principal, tx.interestRate, tx.installmentsCount);
            const paidCount = tx.paymentHistory ? tx.paymentHistory.length : 0;
            const remainingInstallments = tx.installmentsCount - paidCount;
            const remainingTotal = totals.totalPerInstallment * remainingInstallments;
            
            const initials = tx.person.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);

            listHtml += `
                <div class="transaction-list-item ${tx.type}" data-id="${tx.id}" onclick="showDetailModal('${tx.id}')">
                    <div class="avatar-icon">${initials}</div>
                    <div class="info-section">
                        <strong>${tx.person}</strong>
                        <p style="margin: 3px 0 0; font-size: 0.9em;">
                           ${tx.type === 'piutang' ? 'Piutang' : 'Utang'} | Cicilan ${paidCount + 1} dari ${tx.installmentsCount}
                        </p>
                        <span class="status-badge ${dueStatus.class}" style="margin-top: 5px;">${dueStatus.badge}</span>
                    </div>
                    <div class="amount-section">
                        <div class="remaining-amount" style="color: ${tx.type === 'piutang' ? 'var(--success-color)' : 'var(--danger-color)'};">Rp ${formatCurrency(remainingTotal)}</div>
                        <div class="due-info">Jatuh Tempo: ${nextDueDate ? new Date(nextDueDate).toLocaleDateString('id-ID') : '-'}</div>
                    </div>
                </div>
            `;
        });
        latestContainer.innerHTML = listHtml;
    }
    
    function renderChart() {
        const totals = getFinancialTotals();
        const ctx = document.getElementById('piutangChart').getContext('2d');
        
        if (piutangChartInstance) {
            piutangChartInstance.destroy();
        }

        piutangChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Sisa Piutang', 'Sisa Utang'],
                datasets: [{
                    data: [totals.sisaPiutang, totals.sisaUtang],
                    backgroundColor: [
                        'var(--success-color)',
                        'var(--danger-color)'
                    ],
                    hoverOffset: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            font: { size: 12 }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed !== null) {
                                    label += 'Rp ' + formatCurrency(context.parsed);
                                }
                                return label;
                            }
                        }
                    },
                    datalabels: {
                        formatter: (value, context) => {
                            if (value === 0) return '';
                            return 'Rp ' + formatCurrency(value);
                        },
                        color: '#fff',
                        font: { weight: 'bold', size: 10 }
                    }
                }
            },
            plugins: [ChartDataLabels]
        });
    }

    // ===================================
    // 4. FUNGSI NAVIGASI & INTERAKSI (TETAP)
    // ===================================
    
    function navigateTo(pageId) {
        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });
        document.getElementById(pageId).classList.add('active');
        
        document.querySelectorAll('#sideMenuContent .menu-item').forEach(item => {
             item.classList.remove('active');
             if (item.getAttribute('data-page') === pageId) {
                 item.classList.add('active');
             }
        });

        // Trigger render when navigating to certain pages
        if (pageId === 'homePage') {
            renderSummaryCards();
            renderLatestTransactions();
            renderChart();
        } else if (pageId === 'piutangPage') {
             renderTransactionList('piutang', 'piutangList');
        } else if (pageId === 'utangPage') {
             renderTransactionList('utang', 'utangList');
        } else if (pageId === 'historyPage') {
             renderTransactionList('history', 'historyList');
        } else if (pageId === 'summaryPage') {
            renderSummaryCards(); // Refresh summary in case of any change
        }
        
        closeSideMenu();
    }
    
    function sortTransactions(a, b, sortValue) {
        if (sortValue === 'due_asc') {
            const nextDueA = calculateNextDueDate(a) || '9999-12-31';
            const nextDueB = calculateNextDueDate(b) || '9999-12-31';
            return nextDueA.localeCompare(nextDueB);
        } else if (sortValue === 'due_desc') {
            const nextDueA = calculateNextDueDate(a) || '0000-01-01';
            const nextDueB = calculateNextDueDate(b) || '0000-01-01';
            return nextDueB.localeCompare(nextDueA);
        } else if (sortValue === 'amount_desc') {
            const totalsA = calculateTotal(a.principal, a.interestRate, a.installmentsCount);
            const remainingA = totalsA.totalPerInstallment * (a.installmentsCount - (a.paymentHistory ? a.paymentHistory.length : 0));
            const totalsB = calculateTotal(b.principal, b.interestRate, b.installmentsCount);
            const remainingB = totalsB.totalPerInstallment * (b.installmentsCount - (b.paymentHistory ? b.paymentHistory.length : 0));
            return remainingB - remainingA;
        } else if (sortValue === 'lunas_desc') {
            const dateA = a.dateCompleted || '0000-01-01';
            const dateB = b.dateCompleted || '0000-01-01';
            return dateB.localeCompare(dateA);
        } else if (sortValue === 'principal_desc') {
            return cleanPrincipal(b.principal) - cleanPrincipal(a.principal);
        }
    }

    function filterTransactionList(type) {
         renderTransactionList(type, `${type}List`);
    }

    function openSideMenu() {
        sideMenuModal.style.display = 'block';
        setTimeout(() => {
            sideMenuContent.style.transform = 'translateX(0)';
        }, 10);
    }

    function closeSideMenu() {
        sideMenuContent.style.transform = 'translateX(-100%)';
        setTimeout(() => {
            sideMenuModal.style.display = 'none';
        }, 300);
    }

    // ===================================
    // 5. FUNGSI FORM & MODAL (TETAP)
    // ===================================

    form.addEventListener('submit', function(e) {
        e.preventDefault();

        const principalClean = cleanPrincipal(principalInput.value);
        const rateClean = cleanInterestRate(interestRateInput.value); 
        const installments = parseInt(installmentsCountInput.value);
        const finalDueDate = calculateDueDate();

        if (principalClean <= 0 || rateClean < 0 || installments <= 0) {
            alert('Jumlah Pokok, Suku Bunga (>=0), dan Cicilan (>0) harus diisi dengan benar.');
            return;
        }

        const newTransaction = {
            id: Date.now().toString(),
            type: document.getElementById('type').value,
            person: document.getElementById('person').value,
            principal: principalClean,
            startDate: document.getElementById('startDate').value,
            interestRate: rateClean,
            installmentsCount: installments,
            status: 'aktif',
            dateCompleted: null,
            paymentHistory: []
        };

        transactions.unshift(newTransaction);
        saveTransactions();
        alert('Transaksi berhasil dicatat!');
        form.reset();
        finalDueDateDisplay.textContent = 'Pilih tanggal mulai dan tenor/cicilan.';
        estimateDiv.style.display = 'none';
        navigateTo('homePage'); // Kembali ke beranda setelah submit
    });
    
    function showDetailModal(id) {
        const tx = transactions.find(t => t.id === id);
        if (!tx) return;

        const modal = document.getElementById('transactionDetailModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalContent = document.getElementById('modalContent');
        const modalActions = document.getElementById('modalActions');
        
        const totals = calculateTotal(tx.principal, tx.interestRate, tx.installmentsCount);
        const paidCount = tx.paymentHistory ? tx.paymentHistory.length : 0;
        const remainingInstallments = tx.installmentsCount - paidCount;
        const remainingTotal = totals.totalPerInstallment * remainingInstallments;
        const nextDueDate = calculateNextDueDate(tx);

        modalTitle.textContent = `${tx.type === 'piutang' ? 'Piutang' : 'Utang'} dengan ${tx.person}`;
        
        let historyHtml = tx.paymentHistory && tx.paymentHistory.length > 0
            ? tx.paymentHistory.map((p, index) => `
                <div>
                    <span>Cicilan ke-${index + 1} (${new Date(p.date).toLocaleDateString('id-ID')})</span>
                    <strong>Rp ${formatCurrency(p.amount)}</strong>
                </div>
              `).join('')
            : '<p style="text-align: center; font-size: 0.9em; color: var(--text-muted);">Belum ada riwayat pembayaran.</p>';

        modalContent.innerHTML = `
            <div class="modal-detail-row"><span>Status:</span> <strong>${tx.status.toUpperCase()}</strong></div>
            <div class="modal-detail-row"><span>Pokok Pinjaman:</span> <strong>Rp ${formatCurrency(tx.principal)}</strong></div>
            <div class="modal-detail-row"><span>Total dengan Bunga (${tx.interestRate}%):</span> <strong>Rp ${formatCurrency(totals.totalAmount)}</strong></div>
            <div class="modal-detail-row"><span>Tenor/Cicilan:</span> <strong>${tx.installmentsCount} Bulan</strong></div>
            <div class="modal-detail-row"><span>Cicilan per Bulan:</span> <strong>Rp ${formatCurrency(totals.totalPerInstallment)}</strong></div>
            <hr style="margin: 10px 0;">
            <div class="modal-detail-row" style="font-size: 1.1em; font-weight: bold; color: ${tx.type === 'piutang' ? 'var(--success-color)' : 'var(--danger-color)'};">
                <span>Sisa Total:</span> <strong>Rp ${formatCurrency(remainingTotal)}</strong>
            </div>
            ${tx.status === 'aktif' ? `
                <div class="modal-detail-row"><span>Sisa Cicilan:</span> <strong>${remainingInstallments} dari ${tx.installmentsCount}</strong></div>
                <div class="modal-detail-row"><span>Jatuh Tempo Cicilan Berikut:</span> <strong>${nextDueDate ? new Date(nextDueDate).toLocaleDateString('id-ID') : '-'}</strong></div>
            ` : ''}
            
            <h3>Riwayat Pembayaran (${paidCount}x)</h3>
            <div class="payment-history-list">${historyHtml}</div>
        `;

        modalActions.innerHTML = '';
        if (tx.status === 'aktif') {
            if (remainingInstallments > 0) {
                 modalActions.innerHTML += `<button style="background-color: var(--success-color);" onclick="recordPayment('${tx.id}', ${totals.totalPerInstallment})">Catat Pembayaran Cicilan (Rp ${formatCurrency(totals.totalPerInstallment)})</button>`;
            }
            modalActions.innerHTML += `<button style="background-color: var(--danger-color);" onclick="deleteTransaction('${tx.id}')">Hapus Transaksi</button>`;
        } else {
             modalActions.innerHTML += `<p style="text-align: center; color: var(--success-color); font-weight: bold;">Transaksi ini sudah LUNAS.</p>`;
             modalActions.innerHTML += `<button style="background-color: var(--danger-color);" onclick="deleteTransaction('${tx.id}')">Hapus Transaksi (Riwayat)</button>`;
        }
        
        modal.style.display = 'block';
    }

    function closeDetailModal() {
        document.getElementById('transactionDetailModal').style.display = 'none';
    }
    
    function recordPayment(id, installmentAmount) {
        if (!confirm(`Konfirmasi pembayaran cicilan sebesar Rp ${formatCurrency(installmentAmount)}?`)) return;

        const tx = transactions.find(t => t.id === id);
        if (!tx || tx.status !== 'aktif') return;

        tx.paymentHistory.push({
            date: new Date().toISOString().split('T')[0],
            amount: installmentAmount
        });

        if (tx.paymentHistory.length >= tx.installmentsCount) {
            tx.status = 'lunas';
            tx.dateCompleted = new Date().toISOString().split('T')[0];
        }

        saveTransactions();
        alert(`Pembayaran cicilan ke-${tx.paymentHistory.length} berhasil dicatat!`);
        closeDetailModal();
        reRenderAllLists();
    }
    
    function deleteTransaction(id) {
        if (!confirm('Apakah Anda yakin ingin menghapus transaksi ini? Aksi ini tidak dapat dibatalkan.')) return;

        transactions = transactions.filter(t => t.id !== id);
        saveTransactions();
        alert('Transaksi berhasil dihapus.');
        closeDetailModal();
        reRenderAllLists();
    }
    
    // ===================================
    // 6. FUNGSI UTAMA & INITIALIZATION (TETAP)
    // ===================================
    
    function reRenderAllLists() {
        renderSummaryCards();
        renderChart();
        renderLatestTransactions();
        // Cek halaman aktif dan render ulang hanya yang diperlukan
        const activePageId = document.querySelector('.page.active').id;
        if (activePageId === 'piutangPage') renderTransactionList('piutang', 'piutangList');
        if (activePageId === 'utangPage') renderTransactionList('utang', 'utangList');
        if (activePageId === 'historyPage') renderTransactionList('history', 'historyList');
        if (activePageId === 'homePage') {
            renderSummaryCards();
            renderLatestTransactions();
            renderChart();
        }
        if (activePageId === 'summaryPage') renderSummaryCards();
    }

    function exportToCSV() {
        if (transactions.length === 0) {
            alert('Tidak ada data untuk diexport.');
            return;
        }

        let csv = 'ID,Tipe,Orang,Pokok (Rp),Tgl Mulai,Bunga (%),Tenor (Bulan),Total Akhir (Rp),Sisa (Rp),Status,Tgl Lunas,Riwayat Pembayaran\n';

        transactions.forEach(tx => {
            const totals = calculateTotal(tx.principal, tx.interestRate, tx.installmentsCount);
            const paidCount = tx.paymentHistory ? tx.paymentHistory.length : 0;
            const remainingInstallments = tx.installmentsCount - paidCount;
            const remainingTotal = totals.totalPerInstallment * remainingInstallments;
            
            const paymentDetails = tx.paymentHistory 
                ? tx.paymentHistory.map((p, i) => `Cicilan ${i+1}: Rp${p.amount} (${p.date})`).join(';')
                : '';

            const row = [
                tx.id,
                tx.type,
                `"${tx.person.replace(/"/g, '""')}"`, 
                tx.principal,
                tx.startDate,
                tx.interestRate,
                tx.installmentsCount,
                Math.round(totals.totalAmount),
                Math.round(remainingTotal),
                tx.status,
                tx.dateCompleted || '',
                `"${paymentDetails.replace(/"/g, '""')}"`
            ].join(',');
            
            csv += row + '\n';
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        if (link.download !== undefined) { 
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "catatan_hutang_piutang_export_" + new Date().toISOString().split('T')[0] + ".csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            alert('Data berhasil diexport ke CSV!');
        }
    }


    document.addEventListener('DOMContentLoaded', () => {
        loadTransactions();
        reRenderAllLists(); 
        calculateDueDate(); 

        menuToggle.addEventListener('click', openSideMenu);
        sideMenuModal.addEventListener('click', (e) => {
            if (e.target.id === 'sideMenuModal') {
                closeSideMenu();
            }
        });
        
        menuItems.forEach(item => {
            item.addEventListener('click', () => {
                const pageId = item.getAttribute('data-page');
                navigateTo(pageId);
            });
        });
    });
    </script>
</body>
</html>
