<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Utang-Piutang Saya (Personal Finance Tracker)</title>
    
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script> 
<style>
    /* Gaya CSS (Penyesuaian untuk Sorting Control) */
    body { 
        font-family: sans-serif; 
        margin: 0; 
        background-color: #f4f4f9; 
        display: flex; 
        flex-direction: column; 
        min-height: 100vh; 
    }
    .header { 
        background-color: #007bff; 
        color: white; 
        padding: 15px; 
        text-align: center; 
        box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
    }
    .container { 
        max-width: 450px; 
        width: 100%; 
        margin: 0 auto; 
        background: white; 
        padding: 15px; 
        border-radius: 0; 
        box-shadow: none; 
        flex-grow: 1; 
        overflow-y: auto; 
        -webkit-overflow-scrolling: touch; 
        padding-bottom: 70px; 
    }
    .navigation { 
        position: fixed; 
        bottom: 0; 
        width: 100%; 
        max-width: 450px; 
        left: 50%;
        transform: translateX(-50%);
        background-color: #343a40; 
        display: flex; 
        justify-content: space-around; 
        padding: 10px 0; 
        box-shadow: 0 -2px 5px rgba(0,0,0,0.2);
        z-index: 10;
    }
    .nav-item { 
        color: #ccc; 
        text-align: center; 
        flex-grow: 1;
        padding: 5px 0;
        cursor: pointer;
        transition: color 0.3s, background-color 0.3s; 
    }
    .nav-item:hover, .nav-item.active { 
        color: #007bff; 
        background-color: rgba(255, 255, 255, 0.1);
    }
    .nav-item h4 { margin: 0; font-size: 0.8em; } 
    .page { 
        display: none; 
    } 
    .page.active { display: block; }
    h2 { 
        border-bottom: 2px solid #ccc; 
        padding-bottom: 10px; 
        color: #333; 
        margin-top: 0; 
        font-size: 1.3em; 
        margin-bottom: 15px; 
    } 
    .transaction { 
        padding: 12px; 
        margin-bottom: 8px; 
        border-left: 4px solid; 
        background-color: #fff; 
        box-shadow: 0 1px 3px rgba(0,0,0,0.05); 
        border-radius: 4px; 
    }
    .transaction.lunas {
        border-left-color: #adb5bd !important; 
        opacity: 0.7; 
        background-color: #f8f9fa;
    }

    /* GAYA BARU UNTUK SEARCH & SORT BAR */
    .controls-container {
        margin-bottom: 15px;
        padding: 5px 0;
        border-bottom: 1px solid #eee;
    }
    .search-container input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 20px;
        box-sizing: border-box;
        font-size: 1em;
        margin-bottom: 10px;
    }
    .sort-controls {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.9em;
    }
    .sort-controls select {
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 0.9em;
    }

    /* GAYA UNTUK INDIKATOR TERLAMBAT */
    .late-indicator {
        display: inline-block;
        background-color: #ffcdd2; 
        color: #c62828; 
        padding: 3px 8px;
        margin-left: 10px;
        border-radius: 4px;
        font-size: 0.75em;
        font-weight: bold;
        border: 1px solid #ef9a9a;
    }

    /* GAYA UNTUK RIWAYAT PEMBAYARAN */
    .payment-history-list {
        margin-top: 10px;
        border-top: 1px dashed #ccc;
        padding-top: 5px;
        max-height: 100px; 
        overflow-y: auto;
    }
    .payment-history-list div {
        font-size: 0.8em;
        padding: 2px 0;
        border-bottom: 1px dotted #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .payment-history-list div:last-child {
        border-bottom: none;
    }

    /* Gaya Dashboard dan Form (diabaikan untuk singkatnya, tapi tetap ada di kode) */
    #mainDashboard { display: flex; flex-wrap: wrap; justify-content: space-around; margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; background-color: #e9ecef; }
    .summary-card { flex-basis: 30%; padding: 8px 4px; border-radius: 4px; text-align: center; margin-bottom: 10px; }
    .summary-card h3 { margin-top: 0; font-size: 0.7em; color: #555; } 
    .summary-card p { font-size: 1.1em; font-weight: bold; margin: 3px 0 0; } 
    .card-piutang { background-color: #d4edda; border: 1px solid #c3e6cb; }
    .card-utang { background-color: #f8d7da; border: 1px solid #f5c6cb; }
    .card-networth { background-color: #fff3cd; border: 1px solid #ffeeba; }
    #chartArea { max-width: 100%; height: 250px; margin: 15px auto; padding: 10px; border: 1px solid #ddd; border-radius: 6px; background-color: white; display: flex; align-items: center; justify-content: center; }
    input[type="text"], input[type="number"], input[type="date"], select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 1em; }
    button { padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px; font-size: 0.9em; }
    
    /* GAYA BARU UNTUK DAFTAR RINGKAS PIUTANG */
    .transaction.compact {
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer; 
    }
    .transaction.compact .info {
        flex-grow: 1;
    }
    .transaction.compact .date {
        font-weight: bold;
        color: #007bff;
        text-align: right;
        min-width: 100px;
    }
    .transaction.compact p {
        margin: 0;
        line-height: 1.4;
    }

    /* GAYA MODAL */
    .modal-detail-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
        border-bottom: 1px dotted #eee;
        padding-bottom: 3px;
        font-size: 0.95em;
    }
    #modalContent .payment-history-list {
        max-height: 150px;
    }
    .modal-detail-row:last-of-type {
        border-bottom: none;
    }
    .modal-detail-row strong {
        color: #333;
    }
</style>
</head>
<body>

    <div class="header">
        <h1>Pencatat Keuangan Pribadi</h1>
    </div>

    <div class="container">
        
        <div id="homePage" class="page active">
            <h2>Ringkasan Total Aktif üìä</h2>
            <div id="mainDashboard"></div>
            <h2>Status Piutang (Grafik) üìà</h2>
            <div id="chartArea">
                <canvas id="piutangChart"></canvas>
            </div>
        </div>
        
        <div id="formPage" class="page">
            <h2>Tambah Transaksi Baru ‚ûï</h2>
            <form id="transactionForm">
                <div><label for="type">Tipe Transaksi:</label><select id="type" required><option value="piutang">Piutang (Orang Lain Berutang Kepada Saya)</option><option value="utang">Utang (Saya Berutang Kepada Orang Lain)</option></select></div>
                <div><label for="person">Nama Pihak/Orang:</label><input type="text" id="person" required></div>
                <div><label for="principal">Jumlah Pokok (Rp):</label><input type="text" id="principal" required onkeyup="formatInputRupiah(this); updateInstallmentEstimate()"></div>
                
                <div><label for="startDate">Tanggal Mulai Pinjam:</label><input type="date" id="startDate" required onchange="calculateDueDate()"></div>
                
                <div><label for="interestRate">Suku Bunga (% per Bulan):</label><input type="text" id="interestRate" min="0" value="0" required onkeyup="updateInstallmentEstimate()"></div>
                <div><label for="installmentsCount">Tenor/Jumlah Cicilan (Bulan):</label><input type="number" id="installmentsCount" min="1" value="1" required onchange="updateInstallmentEstimate(); calculateDueDate()"></div>
                <div id="installmentEstimate"></div>
                
                <div><label>Tanggal Jatuh Tempo Terakhir:</label><p id="finalDueDateDisplay" style="padding: 8px; border: 1px solid #ddd; background-color: #f8f8f8; border-radius: 4px; margin-top: 0;"></p></div>
                
                <button type="submit">Catat Transaksi</button>
            </form>
        </div>

        <div id="piutangPage" class="page">
            <h2>Daftar Piutang Aktif Saya ‚úÖ</h2>
            <div class="controls-container">
                <div class="search-container"><input type="text" id="searchPiutang" placeholder="Cari Piutang berdasarkan nama..." onkeyup="filterTransactionList('piutang')"></div>
                <div class="sort-controls">
                    <label for="sortPiutang">Urutkan:</label>
                    <select id="sortPiutang" onchange="filterTransactionList('piutang')">
                        <option value="due_asc">Jatuh Tempo Terdekat</option>
                        <option value="due_desc">Jatuh Tempo Terlama</option>
                        <option value="name_asc">Nama (A-Z)</option>
                        <option value="name_desc">Nama (Z-A)</option>
                        <option value="amount_desc">Sisa (Terbesar)</option>
                        <option value="amount_asc">Sisa (Terkecil)</option>
                    </select>
                </div>
            </div>
            <div id="piutangList"><p>Memuat data piutang...</p></div>
        </div>

        <div id="utangPage" class="page">
            <h2>Daftar Utang Aktif Saya ‚ùå</h2>
            <div class="controls-container">
                <div class="search-container"><input type="text" id="searchUtang" placeholder="Cari Utang berdasarkan nama..." onkeyup="filterTransactionList('utang')"></div>
                <div class="sort-controls">
                    <label for="sortUtang">Urutkan:</label>
                    <select id="sortUtang" onchange="filterTransactionList('utang')">
                        <option value="due_asc">Jatuh Tempo Terdekat</option>
                        <option value="due_desc">Jatuh Tempo Terlama</option>
                        <option value="name_asc">Nama (A-Z)</option>
                        <option value="name_desc">Nama (Z-A)</option>
                        <option value="amount_desc">Sisa (Terbesar)</option>
                        <option value="amount_asc">Sisa (Terkecil)</option>
                    </select>
                </div>
            </div>
            <div id="utangList"><p>Memuat data utang...</p></div>
        </div>
        
        <div id="historyPage" class="page">
            <h2>Riwayat Lunas (Piutang & Utang) üìú</h2>
            <div class="controls-container">
                <div class="search-container"><input type="text" id="searchHistory" placeholder="Cari Riwayat berdasarkan nama..." onkeyup="filterTransactionList('history')"></div>
                <div class="sort-controls">
                    <label for="sortHistory">Urutkan:</label>
                    <select id="sortHistory" onchange="filterTransactionList('history')">
                        <option value="lunas_desc">Tanggal Lunas Terbaru</option>
                        <option value="lunas_asc">Tanggal Lunas Terlama</option>
                        <option value="name_asc">Nama (A-Z)</option>
                        <option value="name_desc">Nama (Z-A)</option>
                        <option value="principal_desc">Pokok (Terbesar)</option>
                        <option value="principal_asc">Pokok (Terkecil)</option>
                    </select>
                </div>
            </div>
            <div id="historyList"><p>Memuat riwayat lunas...</p></div>
        </div>

        <div id="summaryPage" class="page">
            <h2>Ringkasan Saldo Awal dan Akhir üëë</h2>
            <div id="balanceSummary" class="saldo-ringkasan"></div>
        </div>

    </div>

    <div class="navigation">
        <div class="nav-item active" data-page="homePage"><h4>üè† Beranda</h4></div>
        <div class="nav-item" data-page="formPage"><h4>‚ûï Tambah</h4></div>
        <div class="nav-item" data-page="piutangPage"><h4>‚úÖ Piutang</h4></div>
        <div class="nav-item" data-page="utangPage"><h4>‚ùå Utang</h4></div>
        <div class="nav-item" data-page="historyPage"><h4>üìú Riwayat</h4></div>
        <div class="nav-item" data-page="summaryPage"><h4>üëë Ringkasan</h4></div>
    </div>
    
    <div id="transactionDetailModal" style="
        display: none; 
        position: fixed; 
        z-index: 1000; 
        left: 0; 
        top: 0; 
        width: 100%; 
        height: 100%; 
        overflow: auto; 
        background-color: rgba(0,0,0,0.4); 
    ">
        <div style="
            background-color: #fefefe;
            margin: 15% auto; 
            padding: 20px;
            border: 1px solid #888;
            width: 90%; 
            max-width: 400px;
            border-radius: 8px;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
        ">
            <span onclick="closeDetailModal()" style="
                color: #aaa; 
                float: right; 
                font-size: 28px; 
                font-weight: bold;
                cursor: pointer;
            ">&times;</span>
            <h3 id="modalTitle">Detail Transaksi</h3>
            <div id="modalContent">
                </div>
            <div id="modalActions" style="margin-top: 15px;">
                </div>
        </div>
    </div>
    <script>
    let transactions = [];
    const form = document.getElementById('transactionForm');
    const piutangListContainer = document.getElementById('piutangList');
    const utangListContainer = document.getElementById('utangList');
    const historyListContainer = document.getElementById('historyList'); 
    const navItems = document.querySelectorAll('.nav-item');
    
    // Ambil elemen form
    const principalInput = document.getElementById('principal');
    const interestRateInput = document.getElementById('interestRate');
    const installmentsCountInput = document.getElementById('installmentsCount');
    const startDateInput = document.getElementById('startDate'); // INPUT BARU
    const finalDueDateDisplay = document.getElementById('finalDueDateDisplay'); // OUTPUT BARU
    const estimateDiv = document.getElementById('installmentEstimate');

    let piutangChartInstance = null; 

    // ===================================
    // 1. MANAJEMEN DATA & LOCAL STORAGE
    // ===================================

    function loadTransactions() {
        const storedTransactions = localStorage.getItem('personalFinanceTracker');
        if (storedTransactions) {
            transactions = JSON.parse(storedTransactions); 
        }
    }

    function saveTransactions() {
        localStorage.setItem('personalFinanceTracker', JSON.stringify(transactions));
    }

    // ===================================
    // 2. FUNGSI UTILITAS
    // ===================================

    function formatInputRupiah(inputElement) {
        let angka = inputElement.value.replace(/\D/g, ''); 
        if (!angka || angka === '0') {
            inputElement.value = '';
            return;
        }
        let formatted = new Intl.NumberFormat('id-ID').format(angka);
        inputElement.value = formatted;
    }

    function formatCurrency(amount) {
        const roundedAmount = Math.round(parseFloat(amount)); 
        return roundedAmount.toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    }
    
    function cleanInterestRate(input) {
        return input.replace(/,/g, '.').replace(/[^0-9.]/g, ''); 
    }

    function calculateTotal(principal, rate, installmentsCount) {
        const principalAmount = parseFloat(principal); 
        const interestRate = parseFloat(rate) / 100; 
        const installments = parseInt(installmentsCount);
        
        if (isNaN(principalAmount) || isNaN(interestRate) || isNaN(installments) || installments === 0) {
            return { totalInterest: 0, totalAmount: 0, totalPerInstallment: 0 };
        }
        
        const totalInterest = principalAmount * interestRate * installments;
        const totalAmount = principalAmount + totalInterest;
        const totalPerInstallment = totalAmount / installments;
        
        return {
            totalInterest: totalInterest,
            totalAmount: totalAmount,
            totalPerInstallment: totalPerInstallment,
        };
    }
    
    function getFinancialTotals() {
        let totalPiutangAwal = 0; 
        let sisaPiutang = 0;      
        let totalUtangAwal = 0;   
        let sisaUtang = 0;        

        const activeTransactions = transactions.filter(tx => tx.status === 'aktif');

        activeTransactions.forEach(tx => {
            // Migrasi data lama (tanpa startDate)
            const dateToUse = tx.startDate || tx.date;
            
            const result = calculateTotal(tx.principal, tx.interestRate, tx.installmentsCount);
            const paidCount = tx.paymentHistory ? tx.paymentHistory.length : 0;
            const remainingInstallments = tx.installmentsCount - paidCount;
            const remainingTotal = result.totalPerInstallment * remainingInstallments;

            if (tx.type === 'piutang') {
                totalPiutangAwal += result.totalAmount; 
                sisaPiutang += remainingTotal;      
            } else if (tx.type === 'utang') {
                totalUtangAwal += result.totalAmount;   
                sisaUtang += remainingTotal;        
            }
        });
        
        const netWorthAwal = totalPiutangAwal - totalUtangAwal;
        const netWorthAkhir = sisaPiutang - sisaUtang;
        
        return {
            totalPiutangAwal, sisaPiutang, 
            totalUtangAwal, sisaUtang,
            netWorthAwal, netWorthAkhir
        };
    }
    
    function updateInstallmentEstimate() {
        const principalFormatted = principalInput.value;
        const principalClean = principalFormatted.replace(/\./g, ''); 
        const rateClean = cleanInterestRate(interestRateInput.value); 
        const installments = parseInt(installmentsCountInput.value);

        if (!principalClean || !rateClean || installments < 1) {
            estimateDiv.style.display = 'none';
            return;
        }

        const result = calculateTotal(principalClean, rateClean, installments);

        if (result.totalPerInstallment > 0) {
            estimateDiv.style.display = 'block';
            estimateDiv.innerHTML = `
                <p style="margin: 0; font-size: 0.9em; color:#0056b3;">
                    Estimasi Cicilan per Bulan (${installments}x): 
                    <strong style="font-size: 1.1em;">Rp ${formatCurrency(result.totalPerInstallment)}</strong>
                    <span style="font-size: 0.8em; color: #555;">(Total akhir: Rp ${formatCurrency(result.totalAmount)})</span>
                </p>
            `;
        } else {
             estimateDiv.style.display = 'none';
        }
    }
    
    // FUNGSI BARU UNTUK MENGHITUNG JATUH TEMPO TERAKHIR
    function calculateDueDate() {
        const startDateValue = startDateInput.value;
        const installments = parseInt(installmentsCountInput.value);
        
        if (!startDateValue || installments < 1) {
            finalDueDateDisplay.textContent = 'Pilih tanggal mulai dan tenor/cicilan.';
            return '';
        }

        const startDate = new Date(startDateValue);
        // Pastikan tanggal valid
        if (isNaN(startDate)) {
            finalDueDateDisplay.textContent = 'Tanggal mulai tidak valid.';
            return '';
        }
        
        // Menambah jumlah bulan cicilan ke tanggal mulai
        // Cicilan pertama jatuh tempo 1 bulan setelah tanggal mulai (tenor 1 bulan)
        // Jatuh tempo terakhir adalah (startDate + installments) bulan.
        // Contoh: Mulai 20 Okt, tenor 1 -> jatuh tempo 20 Nov (1 bulan)
        // Contoh: Mulai 20 Okt, tenor 3 -> jatuh tempo 20 Jan (3 bulan)

        const finalDueDate = new Date(startDate);
        // Menambahkan installments bulan (untuk tanggal jatuh tempo terakhir)
        finalDueDate.setMonth(finalDueDate.getMonth() + installments); 

        // Format tanggal untuk tampilan
        const formattedDate = finalDueDate.toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });
        
        finalDueDateDisplay.textContent = formattedDate;
        
        // Kembalikan dalam format YYYY-MM-DD untuk disimpan
        return finalDueDate.toISOString().split('T')[0];
    }
    
    // FUNGSI BARU UNTUK MENGHITUNG JATUH TEMPO BERIKUTNYA
    function calculateNextDueDate(tx) {
         // Gunakan tx.startDate (baru) atau tx.date (lama) sebagai tanggal mulai
         const dateString = tx.startDate || tx.date;
         
         if (tx.status !== 'aktif' || !dateString) return null;

         const paidCount = tx.paymentHistory ? tx.paymentHistory.length : 0;
         if (paidCount >= tx.installmentsCount) return null; 

         const startDate = new Date(dateString); 
         
         // Tanggal jatuh tempo cicilan berikutnya adalah:
         // Tanggal mulai + (paidCount + 1) bulan
         const nextDueDate = new Date(startDate.getFullYear(), startDate.getMonth() + paidCount + 1, startDate.getDate());

         return nextDueDate;
    }


    function calculateDelay(tx) {
        const nextDueDate = calculateNextDueDate(tx);

        if (!nextDueDate) return null;

        const today = new Date();
        
        // Hapus waktu untuk perbandingan yang akurat
        const todayDateOnly = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        const nextDueDateOnly = new Date(nextDueDate.getFullYear(), nextDueDate.getMonth(), nextDueDate.getDate());

        if (nextDueDateOnly < todayDateOnly) {
            const diffTime = Math.abs(todayDateOnly - nextDueDateOnly);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            return diffDays;
        }
        return 0; 
    }

    // ===================================
    // 3. FUNGSI RENDER (TAMPILAN)
    // ===================================

    function renderMainDashboard() {
        const mainDashboard = document.getElementById('mainDashboard');
        const { totalPiutangAwal, sisaPiutang, totalUtangAwal, sisaUtang, netWorthAkhir } = getFinancialTotals();

        mainDashboard.innerHTML = `
            <div class="summary-card card-piutang">
                <h3>Aset (Sisa Piutang)</h3>
                <p>Rp ${formatCurrency(sisaPiutang)}</p>
                <p style="font-size:0.7em; margin-top: 3px;">(Awal: Rp ${formatCurrency(totalPiutangAwal)})</p>
            </div>
            <div class="summary-card card-utang">
                <h3>Liabilitas (Sisa Utang)</h3>
                <p>Rp ${formatCurrency(sisaUtang)}</p>
                <p style="font-size:0.7em; margin-top: 3px;">(Awal: Rp ${formatCurrency(totalUtangAwal)})</p>
            </div>
            <div class="summary-card card-networth">
                <h3>Net Worth (Bersih Aktif)</h3>
                <p>Rp ${formatCurrency(netWorthAkhir)}</p>
                <p style="font-size:0.7em; margin-top: 3px; color:${netWorthAkhir >= 0 ? 'green' : 'red'};">${netWorthAkhir >= 0 ? 'Positif' : 'Negatif'}</p>
            </div>
        `;
    }

    // FUNGSI SORTING
    function sortTransactions(txArray, sortKey) {
        const result = txArray.slice(); 

        if (sortKey === 'due_asc' || sortKey === 'due_desc') {
            result.sort((a, b) => {
                const nextDueA = calculateNextDueDate(a);
                const nextDueB = calculateNextDueDate(b);

                // Perlakuan khusus untuk yang sudah lunas/tidak ada jatuh tempo
                if (!nextDueA) return 1;
                if (!nextDueB) return -1;
                
                if (sortKey === 'due_asc') return nextDueA - nextDueB;
                return nextDueB - nextDueA;
            });
        } 
        
        else if (sortKey === 'name_asc' || sortKey === 'name_desc') {
            result.sort((a, b) => {
                const comparison = a.person.localeCompare(b.person);
                return sortKey === 'name_asc' ? comparison : -comparison;
            });
        } 
        
        else if (sortKey === 'amount_asc' || sortKey === 'amount_desc') {
            result.sort((a, b) => {
                const remainingA = calculateTotal(a.principal, a.interestRate, a.installmentsCount).totalPerInstallment * (a.installmentsCount - (a.paymentHistory ? a.paymentHistory.length : 0));
                const remainingB = calculateTotal(b.principal, b.interestRate, b.installmentsCount).totalPerInstallment * (b.installmentsCount - (b.paymentHistory ? b.paymentHistory.length : 0));

                if (sortKey === 'amount_asc') return remainingA - remainingB;
                return remainingB - remainingA;
            });
        }
        
        else if (sortKey === 'lunas_asc' || sortKey === 'lunas_desc') { 
            result.sort((a, b) => {
                const dateA = new Date(a.lunasDate);
                const dateB = new Date(b.lunasDate);
                if (sortKey === 'lunas_asc') return dateA - dateB;
                return dateB - dateA;
            });
        }

        else if (sortKey === 'principal_asc' || sortKey === 'principal_desc') { 
            result.sort((a, b) => {
                const principalA = parseFloat(a.principal);
                const principalB = parseFloat(b.principal);
                if (sortKey === 'principal_asc') return principalA - principalB;
                return principalB - principalA;
            });
        }
        
        return result;
    }


    // FUNGSI RENDER LIST UTAMA (Aktif)
    function renderTransactionList(type, container, searchTerm, sortKey) {
        container.innerHTML = ''; 
        
        let transactionsToDisplay = transactions.filter(tx => tx.type === type && tx.status === 'aktif');
        
        // 1. FILTER
        const lowerCaseSearchTerm = searchTerm.toLowerCase();
        if (lowerCaseSearchTerm) {
            transactionsToDisplay = transactionsToDisplay.filter(tx => 
                tx.person.toLowerCase().includes(lowerCaseSearchTerm)
            );
        }

        // 2. SORTING
        transactionsToDisplay = sortTransactions(transactionsToDisplay, sortKey);


        if (transactionsToDisplay.length === 0) {
            container.innerHTML = `<p style="text-align: center; color: #555; margin-top: 20px;">${searchTerm ? `Tidak ditemukan transaksi '${type}' dengan nama "${searchTerm}".` : `Belum ada transaksi ${type} yang aktif dicatat.`}</p>`;
            return;
        }

        transactionsToDisplay.forEach((tx) => {
            const index = transactions.indexOf(tx); 
            const result = calculateTotal(tx.principal, tx.interestRate, tx.installmentsCount);
            const statusClass = tx.type === 'utang' ? 'utang' : 'piutang';
            const transactionDiv = document.createElement('div');
            
            const paidCount = tx.paymentHistory ? tx.paymentHistory.length : 0;
            const remainingInstallments = tx.installmentsCount - paidCount;
            const remainingTotal = result.totalPerInstallment * remainingInstallments;
            const delayDays = calculateDelay(tx);
            const delayIndicator = delayDays > 0 ? `<span class="late-indicator">${delayDays} Hari</span>` : '';
            
            // Hitung tanggal jatuh tempo berikutnya/terakhir untuk ditampilkan
            const nextDueDate = calculateNextDueDate(tx);
            const finalDueDate = new Date(tx.startDate);
            finalDueDate.setMonth(finalDueDate.getMonth() + tx.installmentsCount); 
            
            const formattedNextDueDate = nextDueDate ? nextDueDate.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' }) : 'Lunas!';
            const formattedFinalDueDate = finalDueDate.toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });


            if (type === 'piutang') {
                // Tampilan Ringkas untuk Piutang
                transactionDiv.classList.add('transaction', statusClass, 'compact');
                transactionDiv.onclick = () => showDetailModal(index); // Tambahkan event click

                transactionDiv.innerHTML = `
                    <div class="info">
                        <p><strong>${tx.person}</strong> ${delayIndicator}</p>
                        <p style="font-size: 0.8em; color: #6c757d;">
                            Pokok: Rp ${formatCurrency(tx.principal)} | Sisa: Rp ${formatCurrency(remainingTotal)}
                        </p>
                    </div>
                    <div class="date">
                         ${remainingTotal > 0 ? formattedNextDueDate : 'Lunas!'}
                    </div>
                `;
            } else {
                // Tampilan Detail (Utang) - Pertahankan tampilan aslinya untuk utang
                transactionDiv.classList.add('transaction', statusClass);
                
                const lastPaymentIndex = paidCount - 1;

                let paymentHistoryHTML = '';
                if (paidCount > 0) {
                    paymentHistoryHTML += '<div class="payment-history-list">';
                    tx.paymentHistory.forEach((payment, idx) => {
                        const formattedPaymentDate = new Date(payment.date).toLocaleDateString('id-ID');
                        const isLast = idx === lastPaymentIndex;
                        paymentHistoryHTML += `
                            <div>
                                <span>Cicilan ke-${idx + 1} (${formattedPaymentDate})</span>
                                ${isLast ? `<button onclick="undoPayment(${index})" style="background-color: #ffc107; color: #333; padding: 3px 6px; font-size: 0.7em; margin: 0;">Cancel</button>` : ''}
                            </div>
                        `;
                    });
                    paymentHistoryHTML += '</div>';
                }

                transactionDiv.innerHTML = `
                    <p><strong>${tx.type === 'utang' ? 'UTANG kepada' : 'PIUTANG dari'} ${tx.person}</strong> ${delayIndicator}</p>
                    <p>Pokok: Rp ${formatCurrency(tx.principal)}</p>
                    <p>Total Bunga: Rp ${formatCurrency(result.totalInterest)}</p>
                    <p><strong>TOTAL AKHIR: Rp ${formatCurrency(result.totalAmount)}</strong></p>
                    
                    <div class="installments">
                        Cicilan (${tx.installmentsCount}x): 
                        <strong>Rp ${formatCurrency(result.totalPerInstallment)}</strong> per bulan.
                    </div>
                    
                    <p>Dibayar: ${paidCount} dari ${tx.installmentsCount} cicilan</p>
                    <p>Sisa: Rp ${formatCurrency(remainingTotal)} (${remainingInstallments} cicilan)</p>
                    
                    <p class="due-date">Tanggal Mulai: ${new Date(tx.startDate).toLocaleDateString('id-ID')}</p>
                    <p class="due-date">Jatuh Tempo Terakhir: ${formattedFinalDueDate}</p>
                    
                    ${paymentHistoryHTML}

                    <div style="margin-top: 10px;">
                        ${remainingInstallments > 0 ? `<button onclick="payInstallment(${index})">Bayar Cicilan</button>` : ''}
                        <button onclick="markPaid(${index})" style="background-color: #6c757d;">Tandai Lunas Penuh</button>
                    </div>
                `;
            }

            container.appendChild(transactionDiv);
        });
    }
    
    // FUNGSI RENDER RIWAYAT LUNAS (Tetap Sama)
    function renderHistoryList(searchTerm, sortKey) {
        historyListContainer.innerHTML = '';
        
        let historyTransactions = transactions.filter(tx => tx.status === 'lunas');
        
        // 1. FILTER
        const lowerCaseSearchTerm = searchTerm.toLowerCase();
        if (lowerCaseSearchTerm) {
            historyTransactions = historyTransactions.filter(tx => 
                tx.person.toLowerCase().includes(lowerCaseSearchTerm)
            );
        }

        // 2. SORTING
        historyTransactions = sortTransactions(historyTransactions, sortKey);

        if (historyTransactions.length === 0) {
            historyListContainer.innerHTML = `<p style="text-align: center; color: #555; margin-top: 20px;">${searchTerm ? `Tidak ditemukan riwayat lunas dengan nama "${searchTerm}".` : `Belum ada riwayat transaksi lunas.`}</p>`;
            return;
        }
        
        historyTransactions.forEach(tx => {
            const index = transactions.indexOf(tx);
            const result = calculateTotal(tx.principal, tx.interestRate, tx.installmentsCount);
            const statusClass = tx.type === 'utang' ? 'utang' : 'piutang';
            const paidCount = tx.paymentHistory ? tx.paymentHistory.length : 0;
            
            const transactionDiv = document.createElement('div');
            transactionDiv.classList.add('transaction', statusClass, 'lunas'); 
            
            const formattedDate = new Date(tx.lunasDate).toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });

            let historyDetail = '';
            if (paidCount > 0 && tx.paymentHistory) {
                 historyDetail += '<div class="payment-history-list">';
                 tx.paymentHistory.forEach((payment, idx) => {
                     const formattedPaymentDate = new Date(payment.date).toLocaleDateString('id-ID');
                     historyDetail += `<div><span>Cicilan ke-${idx + 1} (${formattedPaymentDate})</span></div>`;
                 });
                 historyDetail += '</div>';
            }


            transactionDiv.innerHTML = `
                <p><strong>[LUNAS] ${tx.type === 'utang' ? 'UTANG kepada' : 'PIUTANG dari'} ${tx.person}</strong></p>
                <p>Pokok: Rp ${formatCurrency(tx.principal)} | Total Akhir: Rp ${formatCurrency(result.totalAmount)}</p>
                <p>Lunas pada: <strong style="color: #333;">${formattedDate}</strong></p>
                <p style="font-size:0.8em; margin-top: 8px;">(Total pembayaran ${paidCount}x dari ${tx.installmentsCount}x)</p>
                
                ${historyDetail}
                
                <div style="margin-top: 10px;">
                    <button onclick="deleteTransaction(${index})" style="background-color: #dc3545; padding: 5px 8px; font-size: 0.8em;">Hapus Permanen</button>
                </div>
            `;
            historyListContainer.appendChild(transactionDiv);
        });
    }


    // FUNGSI GABUNGAN: Pencarian dan Pengurutan
    function filterTransactionList(pageType) {
        let container;
        let searchInput;
        let sortInput;
        let listType;

        if (pageType === 'piutang') {
            container = piutangListContainer;
            searchInput = document.getElementById('searchPiutang');
            sortInput = document.getElementById('sortPiutang');
            listType = 'piutang';
        } else if (pageType === 'utang') {
            container = utangListContainer;
            searchInput = document.getElementById('searchUtang');
            sortInput = document.getElementById('sortUtang');
            listType = 'utang';
        } else if (pageType === 'history') {
            container = historyListContainer;
            searchInput = document.getElementById('searchHistory');
            sortInput = document.getElementById('sortHistory');
            listType = 'history';
        } else {
            return;
        }

        const searchTerm = searchInput.value;
        const sortKey = sortInput.value;

        if (listType === 'history') {
            renderHistoryList(searchTerm, sortKey);
        } else {
            renderTransactionList(listType, container, searchTerm, sortKey);
        }
    }


    // ===================================
    // 4. MANAJEMEN APLIKASI (Logic & Modal)
    // ===================================

    // FUNGSI MODAL BARU
    function closeDetailModal() {
        document.getElementById('transactionDetailModal').style.display = 'none';
    }

    function showDetailModal(index) {
        const tx = transactions[index];
        const result = calculateTotal(tx.principal, tx.interestRate, tx.installmentsCount);
        const paidCount = tx.paymentHistory ? tx.paymentHistory.length : 0;
        const remainingInstallments = tx.installmentsCount - paidCount;
        const remainingTotal = result.totalPerInstallment * remainingInstallments;
        
        // Menggunakan fungsi yang sudah diperbarui
        const nextDueDate = calculateNextDueDate(tx);
        const finalDueDate = new Date(tx.startDate);
        finalDueDate.setMonth(finalDueDate.getMonth() + tx.installmentsCount); 
        
        const formattedFinalDueDate = finalDueDate.toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });
        
        const lastPaymentIndex = paidCount - 1;
        const delayDays = calculateDelay(tx);
        const delayIndicator = delayDays > 0 ? `<span class="late-indicator" style="margin-left: 0;">Terlambat ${delayDays} hari</span>` : '';
        
        // --- Konten Riwayat Pembayaran ---
        let paymentHistoryHTML = '';
        if (paidCount > 0) {
            paymentHistoryHTML += '<h4 style="border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-top: 15px; font-size: 1em;">Riwayat Pembayaran</h4>';
            paymentHistoryHTML += '<div class="payment-history-list">';
            tx.paymentHistory.forEach((payment, idx) => {
                const formattedPaymentDate = new Date(payment.date).toLocaleDateString('id-ID');
                const isLast = idx === lastPaymentIndex;
                paymentHistoryHTML += `
                    <div>
                        <span>Cicilan ke-${idx + 1} (${formattedPaymentDate})</span>
                        ${isLast ? `<button onclick="undoPayment(${index}); closeDetailModal()" style="background-color: #ffc107; color: #333; padding: 3px 6px; font-size: 0.7em; margin: 0;">Cancel</button>` : ''}
                    </div>
                `;
            });
            paymentHistoryHTML += '</div>';
        }

        // --- Konten Utama Modal ---
        document.getElementById('modalTitle').innerHTML = `${tx.type === 'utang' ? 'UTANG' : 'PIUTANG'} dari ${tx.person} ${delayIndicator}`;
        document.getElementById('modalContent').innerHTML = `
            <div class="modal-detail-row">
                <span>Pokok Pinjaman:</span>
                <strong>Rp ${formatCurrency(tx.principal)}</strong>
            </div>
            <div class="modal-detail-row">
                <span>Suku Bunga (${tx.interestRate}%/bln):</span>
                <strong>Rp ${formatCurrency(result.totalInterest)}</strong>
            </div>
            <div class="modal-detail-row" style="margin-top: 10px; font-size: 1.1em; font-weight: bold; border-top: 1px solid #ddd;">
                <span>TOTAL AKHIR:</span>
                <strong>Rp ${formatCurrency(result.totalAmount)}</strong>
            </div>
            <div style="border-top: 1px dashed #ccc; margin: 10px 0;"></div>
            <div class="modal-detail-row">
                <span>Tanggal Mulai:</span>
                <strong>${new Date(tx.startDate).toLocaleDateString('id-ID')}</strong>
            </div>
            <div class="modal-detail-row">
                <span>Jatuh Tempo Terakhir:</span>
                <strong>${formattedFinalDueDate}</strong>
            </div>
            <div class="modal-detail-row">
                <span>Cicilan per Bulan (${tx.installmentsCount}x):</span>
                <strong>Rp ${formatCurrency(result.totalPerInstallment)}</strong>
            </div>
            <div class="modal-detail-row">
                <span>Telah Dibayar:</span>
                <strong>${paidCount} dari ${tx.installmentsCount} cicilan</strong>
            </div>
            <div class="modal-detail-row">
                <span>Sisa Pembayaran:</span>
                <strong style="color: ${remainingTotal > 0 ? '#dc3545' : '#28a745'};">Rp ${formatCurrency(remainingTotal)} (${remainingInstallments} cicilan)</strong>
            </div>
            ${paymentHistoryHTML}
        `;

        // --- Tombol Aksi Modal ---
        document.getElementById('modalActions').innerHTML = `
            ${remainingInstallments > 0 ? `<button onclick="payInstallment(${index}); closeDetailModal()">Bayar Cicilan</button>` : ''}
            <button onclick="markPaid(${index}); closeDetailModal()" style="background-color: #6c757d;">Tandai Lunas Penuh</button>
        `;

        document.getElementById('transactionDetailModal').style.display = 'block';
    }


    function payInstallment(index) {
        const tx = transactions[index];
        if (!tx.paymentHistory) tx.paymentHistory = [];
        
        const paidCount = tx.paymentHistory.length;
        
        if (paidCount < tx.installmentsCount) {
            const nextInstallmentNumber = paidCount + 1;
            tx.paymentHistory.push({
                installment: nextInstallmentNumber,
                date: new Date().toISOString().slice(0, 10)
            });
            
            alert(`Cicilan ke-${nextInstallmentNumber} untuk ${tx.person} berhasil dibayar pada ${tx.paymentHistory[tx.paymentHistory.length - 1].date}.`);
            
            if(tx.paymentHistory.length === tx.installmentsCount) {
                tx.status = 'lunas';
                tx.lunasDate = new Date().toISOString().slice(0, 10);
                alert(`Selamat! Transaksi ${tx.person} telah lunas penuh!`);
            }
            
            saveTransactions();
            refreshAllPagesAndCurrentView();
        } else {
            alert(`Semua cicilan untuk ${tx.person} sudah lunas.`);
        }
    }

    function undoPayment(index) {
        const tx = transactions[index];
        if (!tx.paymentHistory || tx.paymentHistory.length === 0) {
            alert("Tidak ada pembayaran yang bisa dibatalkan.");
            return;
        }

        if (confirm(`Apakah Anda yakin ingin membatalkan pembayaran cicilan terakhir (ke-${tx.paymentHistory.length}) untuk ${tx.person}?`)) {
            const lastPayment = tx.paymentHistory.pop(); 

            if (tx.status === 'lunas') {
                tx.status = 'aktif';
                tx.lunasDate = null;
            }
            
            saveTransactions();
            alert(`Pembayaran cicilan ke-${lastPayment.installment} (${new Date(lastPayment.date).toLocaleDateString('id-ID')}) untuk ${tx.person} berhasil dibatalkan.`);
            refreshAllPagesAndCurrentView();
        }
    }


    function markPaid(index) {
        if (confirm(`Apakah Anda yakin ingin menandai transaksi ${transactions[index].person} lunas penuh? Ini akan mencatat semua sisa cicilan sebagai sudah dibayar.`)) {
            const tx = transactions[index];
            if (!tx.paymentHistory) tx.paymentHistory = [];
            const paidCount = tx.paymentHistory.length;
            const remaining = tx.installmentsCount - paidCount;

            for (let i = 0; i < remaining; i++) {
                 tx.paymentHistory.push({
                    installment: paidCount + i + 1,
                    date: new Date().toISOString().slice(0, 10) 
                 });
            }

            tx.status = 'lunas';
            tx.lunasDate = new Date().toISOString().slice(0, 10); 
            saveTransactions();
            alert(`Transaksi ${tx.person} berhasil ditandai Lunas Penuh (${remaining} cicilan dituntaskan) dan dipindahkan ke Riwayat!`);
            refreshAllPagesAndCurrentView();
        }
    }
    
    function deleteTransaction(index) {
        if (confirm(`Apakah Anda yakin ingin MENGHAPUS PERMANEN riwayat transaksi ${transactions[index].person}? Tindakan ini tidak dapat dibatalkan.`)) {
            transactions.splice(index, 1);
            saveTransactions();
            alert("Riwayat transaksi berhasil dihapus.");
            refreshAllPagesAndCurrentView();
        }
    }

    form.addEventListener('submit', (e) => {
        e.preventDefault();
        
        // Hitung tanggal jatuh tempo terakhir
        const calculatedDueDate = calculateDueDate();

        if (!calculatedDueDate) {
            alert("Harap lengkapi Tanggal Mulai dan Tenor/Cicilan.");
            return;
        }

        const principalFormatted = principalInput.value;
        const principalClean = principalFormatted.replace(/\./g, ''); 
        const interestRateClean = cleanInterestRate(interestRateInput.value);

        const newTransaction = {
            type: document.getElementById('type').value,
            person: document.getElementById('person').value,
            principal: principalClean, 
            interestRate: interestRateClean, 
            installmentsCount: parseInt(installmentsCountInput.value), 
            
            // SIMPAN DATA BARU
            startDate: startDateInput.value, 
            date: new Date().toISOString().slice(0, 10), // Tanggal input transaksi
            
            status: 'aktif', 
            lunasDate: null,
            paymentHistory: [] 
        };
        
        if (!newTransaction.principal || parseFloat(newTransaction.principal) < 1 || newTransaction.installmentsCount < 1) {
            alert("Jumlah Pokok dan Jumlah Cicilan harus valid.");
            return;
        }
        
        if (isNaN(parseFloat(newTransaction.interestRate))) {
             alert("Suku Bunga tidak valid.");
             return;
        }

        transactions.push(newTransaction);
        saveTransactions(); 
        form.reset(); 
        estimateDiv.style.display = 'none';
        finalDueDateDisplay.textContent = 'Pilih tanggal mulai dan tenor/cicilan.'; // Reset display
        alert("Transaksi berhasil dicatat!");
        refreshAllPagesAndCurrentView();
        showPage('homePage'); 
    });
    
    // ===================================
    // 5. MANAJEMEN MULTI-PAGE
    // ===================================
    
    function showPage(pageId) {
        const pages = document.querySelectorAll('.page');
        const currentNav = document.querySelector(`.nav-item[data-page="${pageId}"]`);

        pages.forEach(page => page.classList.remove('active'));
        navItems.forEach(nav => nav.classList.remove('active'));

        document.getElementById(pageId).classList.add('active');
        if (currentNav) {
            currentNav.classList.add('active');
        }

        // Render data sesuai halaman
        if (pageId === 'homePage') {
            document.getElementById('mainDashboard') && renderMainDashboard(); 
        } else if (pageId === 'piutangPage') {
            document.getElementById('searchPiutang').value = ''; 
            document.getElementById('sortPiutang').value = 'due_asc'; // Default sort
            filterTransactionList('piutang');
        } else if (pageId === 'utangPage') {
            document.getElementById('searchUtang').value = ''; 
            document.getElementById('sortUtang').value = 'due_asc'; // Default sort
            filterTransactionList('utang');
        } else if (pageId === 'historyPage') { 
            document.getElementById('searchHistory').value = ''; 
            document.getElementById('sortHistory').value = 'lunas_desc'; // Default sort
            filterTransactionList('history');
        } else if (pageId === 'summaryPage') {
             // document.getElementById('balanceSummary') && renderBalanceSummary();
        }
        
        if (pageId !== 'formPage') {
            estimateDiv && (estimateDiv.style.display = 'none');
        } else {
             // Inisialisasi tampilan di halaman form
             finalDueDateDisplay.textContent = 'Pilih tanggal mulai dan tenor/cicilan.'; 
        }
    }

    navItems.forEach(item => {
        item.addEventListener('click', () => {
            const pageId = item.getAttribute('data-page');
            showPage(pageId);
        });
    });

    function refreshAllPagesAndCurrentView() {
        const activePageElement = document.querySelector('.page.active');
        if (activePageElement) {
             const activePageId = activePageElement.id;
             showPage(activePageId); 
        } else {
             showPage('homePage');
        }
    }
    
    // INISIALISASI APLIKASI
    loadTransactions(); 
    transactions.forEach(tx => {
        if (!tx.status) {
            tx.status = 'aktif';
            tx.lunasDate = null;
        }
        if (tx.paidInstallments !== undefined) {
             if (!tx.paymentHistory) tx.paymentHistory = [];
             while(tx.paymentHistory.length < tx.paidInstallments) {
                 tx.paymentHistory.push({
                     installment: tx.paymentHistory.length + 1,
                     date: tx.date 
                 });
             }
             delete tx.paidInstallments; 
        }
        if (!tx.paymentHistory) tx.paymentHistory = []; 
        
        // MIGRASI DATA LAMA: Jika ada dueDate tapi tidak ada startDate, gunakan tanggal transaksi sebagai startDate.
        if (!tx.startDate && tx.dueDate) {
             tx.startDate = tx.date; 
             // dueDate lama bisa dihapus karena sudah digantikan oleh kalkulasi
             delete tx.dueDate; 
        }
        // Pastikan tx.startDate selalu ada untuk transaksi aktif/lunas
        if (!tx.startDate && tx.date) {
             tx.startDate = tx.date;
        }
        
    });
    saveTransactions();
    showPage('homePage'); 
</script>

</body>
</html>
