<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pencatat Utang Piutang</title>
    
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script> 
<style>
    /* ---------------------------------- */
    /* GAYA UMUM & MOBILE FIRST */
    /* ---------------------------------- */
    :root {
        --primary-color: #007bff; /* Biru cerah */
        --success-color: #28a745; /* Hijau */
        --danger-color: #dc3545; /* Merah */
        --warning-color: #ffc107; /* Kuning */
        --light-bg: #f8f9fa; /* Background halaman */
        --card-bg: #ffffff; /* Background kartu */
        --text-dark: #343a40; /* Teks gelap */
        --text-muted: #6c757d; /* Teks redup */
        --border-color: #dee2e6;
        --shadow-elevation: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    
    body { 
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        margin: 0; 
        background-color: var(--light-bg); 
        display: flex; 
        flex-direction: column; 
        min-height: 100vh; 
        color: var(--text-dark);
    }
    .header { 
        background-color: var(--primary-color); 
        color: white; 
        padding: 18px 15px; 
        text-align: center; 
        box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
        font-size: 1.1em;
    }
    .container { 
        max-width: 450px; 
        width: 100%; 
        margin: 0 auto; 
        background: var(--card-bg); 
        padding: 15px; 
        flex-grow: 1; 
        overflow-y: auto; 
        -webkit-overflow-scrolling: touch; 
        padding-bottom: 70px; 
    }
    .page { display: none; padding-top: 5px; } 
    .page.active { display: block; }
    
    h2 { 
        border-bottom: 2px solid var(--border-color); 
        padding-bottom: 10px; 
        color: var(--text-dark); 
        margin-top: 15px; 
        font-size: 1.4em; 
        font-weight: 600;
        margin-bottom: 20px; 
    } 
    h3 {
         font-size: 1.1em;
         color: var(--text-dark);
         margin-top: 25px;
         margin-bottom: 15px;
         font-weight: 600;
    }
    
    /* ---------------------------------- */
    /* GAYA NAVIGASI (TAB BAR) */
    /* ---------------------------------- */
    .navigation { 
        position: fixed; 
        bottom: 0; 
        width: 100%; 
        max-width: 450px; 
        left: 50%;
        transform: translateX(-50%);
        background-color: var(--card-bg); 
        display: flex; 
        justify-content: space-around; 
        height: 60px; 
        box-shadow: 0 -4px 10px rgba(0,0,0,0.1); 
        z-index: 10;
        border-top: 1px solid var(--border-color);
    }
    .nav-item { 
        color: var(--text-muted); 
        text-align: center; 
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: color 0.3s; 
    }
    .nav-item.active { 
        color: var(--primary-color); 
    }
    .nav-item h4 { margin: 0; font-size: 0.75em; font-weight: 500;} 
    .nav-item .icon { font-size: 1.3em; margin-bottom: 3px; }

    /* Tombol Tambah (+) */
    .nav-item[data-page="formPage"] {
        position: relative;
        top: -15px; 
        background-color: var(--primary-color);
        color: white;
        width: 55px;
        height: 55px;
        border-radius: 50%;
        box-shadow: 0 6px 15px rgba(0, 123, 255, 0.4);
        font-size: 1.8em;
        line-height: 1;
        padding-top: 0;
    }
    .nav-item[data-page="formPage"] .icon { margin-bottom: 0; }
    .nav-item[data-page="formPage"] h4 { display: none; }
    
    /* ---------------------------------- */
    /* GAYA DASHBOARD & CARD */
    /* ---------------------------------- */
    #mainDashboard { display: flex; flex-wrap: wrap; justify-content: space-between; margin-bottom: 20px; }
    .summary-card { 
        flex-basis: 100%; 
        padding: 15px; 
        border-radius: 12px; 
        text-align: left; 
        margin-bottom: 12px; 
        box-shadow: var(--shadow-elevation);
        transition: all 0.3s;
    }
    .summary-card h3 { 
        margin-top: 0; 
        font-size: 0.9em; 
        color: var(--text-dark); 
        font-weight: 500;
        margin-bottom: 5px;
    } 
    .summary-card p { 
        font-size: 1.4em; 
        font-weight: bold; 
        margin: 0; 
    } 
    .card-piutang { background-color: #e6f7ef; border-left: 5px solid var(--success-color); } 
    .card-utang { background-color: #fcebeb; border-left: 5px solid var(--danger-color); } 
    .card-networth { background-color: #fff8e1; border-left: 5px solid var(--warning-color); font-size: 1.1em; }
    
    /* Layout kolom untuk mobile */
    @media (min-width: 350px) {
        .summary-card { flex-basis: 48%; }
        .card-networth { flex-basis: 100%; margin-top: 5px; }
    }
    
    /* ---------------------------------- */
    /* GAYA LIST TRANSAKSI */
    /* ---------------------------------- */
    .transaction-list-container {
        border: none; 
        padding: 0; 
        border-radius: 0; 
        background-color: var(--light-bg);
    }
    
    .transaction-list-item {
        display: flex;
        align-items: center;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 10px;
        background-color: var(--card-bg);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        cursor: pointer;
        transition: transform 0.1s, box-shadow 0.1s;
    }
    .transaction-list-item:active {
        transform: scale(0.98);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .avatar-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #e9ecef;
        color: var(--primary-color);
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.4em;
        font-weight: 600;
        margin-right: 15px;
        flex-shrink: 0;
    }
    .info-section { flex-grow: 1; min-width: 0; }
    .info-section strong { font-size: 1.1em; color: var(--text-dark); }
    .info-section p { font-size: 0.8em; }
    
    .status-badge {
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 0.7em;
        font-weight: 600;
        margin-right: 5px;
    }
    .status-active { background-color: #d1ecf1; color: #008080; } 
    .status-late { background-color: #f8d7da; color: var(--danger-color); } 
    
    .amount-section { text-align: right; flex-shrink: 0; margin-left: 10px; }
    .amount-section .remaining-amount { font-size: 1.2em; font-weight: bold; color: var(--success-color); }
    .transaction-list-item.utang .amount-section .remaining-amount { color: var(--danger-color); }
    .amount-section .due-info { font-size: 0.75em; color: var(--text-muted); margin-top: 2px; }

    /* ---------------------------------- */
    /* GAYA FORM & CONTROLS */
    /* ---------------------------------- */
    .controls-container {
        margin-bottom: 15px;
        padding: 10px 0;
        border-bottom: 1px solid var(--border-color);
    }
    .search-container input {
        width: 100%;
        padding: 10px 15px;
        border: 1px solid var(--border-color);
        border-radius: 25px;
        box-sizing: border-box;
        font-size: 1em;
        margin-bottom: 10px;
        transition: border-color 0.3s;
    }
    .search-container input:focus {
        border-color: var(--primary-color);
        outline: none;
    }
    
    .sort-controls {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.9em;
        color: var(--text-muted);
    }
    .sort-controls select {
        padding: 8px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 0.9em;
        background-color: white;
    }
    
    label {
         display: block;
         margin-bottom: 5px;
         font-weight: 500;
         color: var(--text-dark);
         font-size: 0.95em;
    }

    input[type="text"], input[type="number"], input[type="date"], select { 
        width: 100%; 
        padding: 12px; 
        border: 1px solid var(--border-color); 
        border-radius: 8px; 
        box-sizing: border-box; 
        font-size: 1em; 
        margin-bottom: 15px;
        background-color: var(--light-bg);
    }
    
    button { 
        padding: 12px 18px; 
        background-color: var(--primary-color); 
        color: white; 
        border: none; 
        border-radius: 8px; 
        cursor: pointer; 
        margin-top: 10px;
        font-size: 1em; 
        font-weight: 600;
        transition: background-color 0.2s;
    }
    button:hover {
         background-color: #0056b3;
    }
    
    /* Gaya untuk tombol Aksi di Modal */
    #modalActions button {
        width: 100%;
        margin-bottom: 8px;
        padding: 10px;
    }

    /* ---------------------------------- */
    /* GAYA MODAL */
    /* ---------------------------------- */
    .modal-detail-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        border-bottom: 1px dotted var(--border-color);
        padding-bottom: 5px;
        font-size: 0.95em;
    }
    #modalContent .payment-history-list {
        max-height: 150px;
        overflow-y: auto;
        padding: 5px;
        border: 1px solid #eee;
        border-radius: 5px;
    }
    #modalContent .payment-history-list div {
        display: flex;
        justify-content: space-between;
        padding: 5px 0;
        border-bottom: 1px dotted #f1f1f1;
        font-size: 0.85em;
    }
</style>
</head>
<body>

    <div class="header">
        <h1>Pencatat Utang Piutang</h1>
    </div>

    <div class="container">
        
        <div id="homePage" class="page active">
            <h2>Beranda üìä</h2>
            <div id="mainDashboard"></div>
            
            <h3 style="margin-top: 25px;">Status Keuangan (Grafik) üìà</h3>
            <div id="chartArea" style="height: 250px; background-color: white; padding: 10px; border-radius: 12px; box-shadow: var(--shadow-elevation); margin-bottom: 20px;">
                <canvas id="piutangChart"></canvas>
            </div>
            
            <h3>Transaksi Aktif Terbaru</h3>
            <div id="latestTransactions" class="transaction-list-container">
                <p style="text-align: center; color: var(--text-muted);">Memuat data...</p>
            </div>
        </div>
        
        <div id="formPage" class="page">
            <h2>Tambah Transaksi Baru ‚ûï</h2>
            <form id="transactionForm">
                <div><label for="type">Tipe Transaksi:</label><select id="type" required><option value="piutang">Piutang (Saya Memberi Pinjaman)</option><option value="utang">Utang (Saya Menerima Pinjaman)</option></select></div>
                <div><label for="person">Nama Pihak/Orang:</label><input type="text" id="person" required></div>
                <div><label for="principal">Jumlah Pokok (Rp):</label><input type="text" id="principal" required onkeyup="formatInputRupiah(this); updateInstallmentEstimate()"></div>
                
                <div><label for="startDate">Tanggal Mulai Pinjam:</label><input type="date" id="startDate" required onchange="calculateDueDate()"></div>
                
                <div><label for="interestRate">Suku Bunga (% per Bulan):</label><input type="text" id="interestRate" min="0" value="0" required onkeyup="updateInstallmentEstimate()"></div>
                <div><label for="installmentsCount">Tenor/Jumlah Cicilan (Bulan):</label><input type="number" id="installmentsCount" min="1" value="1" required onchange="updateInstallmentEstimate(); calculateDueDate()"></div>
                <div id="installmentEstimate" style="padding: 10px; background-color: #e3f2fd; border: 1px solid #bbdefb; border-radius: 8px; margin-bottom: 15px; display: none;"></div>
                
                <div><label>Tanggal Jatuh Tempo Terakhir:</label><p id="finalDueDateDisplay" style="padding: 12px; border: 1px solid #ddd; background-color: #f8f8f8; border-radius: 8px; margin-top: 0;"></p></div>
                
                <button type="submit" style="width: 100%;">Catat Transaksi</button>
            </form>
        </div>

        <div id="piutangPage" class="page">
            <h2>Daftar Piutang Aktif ‚úÖ</h2>
            <div class="controls-container">
                <div class="search-container"><input type="text" id="searchPiutang" placeholder="Cari Piutang berdasarkan nama..." onkeyup="filterTransactionList('piutang')"></div>
                <div class="sort-controls">
                    <label for="sortPiutang">Urutkan:</label>
                    <select id="sortPiutang" onchange="filterTransactionList('piutang')">
                        <option value="due_asc">Jatuh Tempo Terdekat</option>
                        <option value="due_desc">Jatuh Tempo Terlama</option>
                        <option value="amount_desc">Sisa (Terbesar)</option>
                    </select>
                </div>
            </div>
            <div id="piutangList" class="transaction-list-container"><p>Memuat data piutang...</p></div>
        </div>

        <div id="utangPage" class="page">
            <h2>Daftar Utang Aktif ‚ùå</h2>
            <div class="controls-container">
                <div class="search-container"><input type="text" id="searchUtang" placeholder="Cari Utang berdasarkan nama..." onkeyup="filterTransactionList('utang')"></div>
                <div class="sort-controls">
                    <label for="sortUtang">Urutkan:</label>
                    <select id="sortUtang" onchange="filterTransactionList('utang')">
                        <option value="due_asc">Jatuh Tempo Terdekat</option>
                        <option value="due_desc">Jatuh Tempo Terlama</option>
                        <option value="amount_desc">Sisa (Terbesar)</option>
                    </select>
                </div>
            </div>
            <div id="utangList" class="transaction-list-container"><p>Memuat data utang...</p></div>
        </div>
        
        <div id="historyPage" class="page">
            <h2>Riwayat Transaksi Lunas üìú</h2>
            <div class="controls-container">
                <div class="search-container"><input type="text" id="searchHistory" placeholder="Cari Riwayat berdasarkan nama..." onkeyup="filterTransactionList('history')"></div>
                <div class="sort-controls">
                    <label for="sortHistory">Urutkan:</label>
                    <select id="sortHistory" onchange="filterTransactionList('history')">
                        <option value="lunas_desc">Tanggal Lunas Terbaru</option>
                        <option value="principal_desc">Pokok (Terbesar)</option>
                    </select>
                </div>
            </div>
            <div id="historyList" class="transaction-list-container"><p>Memuat riwayat lunas...</p></div>
        </div>

        <div id="summaryPage" class="page">
            <h2>Ringkasan & Export Data üëë</h2>
            
            <div style="background-color: #e9ecef; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                <p style="margin-top:0;">Export data transaksi aktif dan lunas ke dalam format CSV (kompatibel dengan Excel) untuk analisis lebih lanjut.</p>
                <button onclick="exportToCSV()" style="background-color: var(--success-color); width: 100%;">Export Semua Data ke CSV</button>
            </div>

            
            <h3>Ringkasan Saldo Global</h3>
            <div id="balanceSummary" style="border: 1px solid var(--border-color); padding: 15px; border-radius: 12px; background-color: var(--card-bg);">
                <div class="modal-detail-row"><span>Total Piutang (Awal):</span> <strong id="summaryPiutangAwal">Rp 0</strong></div>
                <div class="modal-detail-row"><span>Sisa Piutang (Aktif):</span> <strong id="summaryPiutangSisa">Rp 0</strong></div>
                <hr style="border: none; border-top: 1px dashed #eee; margin: 10px 0;">
                <div class="modal-detail-row"><span>Total Utang (Awal):</span> <strong id="summaryUtangAwal">Rp 0</strong></div>
                <div class="modal-detail-row"><span>Sisa Utang (Aktif):</span> <strong id="summaryUtangSisa">Rp 0</strong></div>
                <hr style="border: none; border-top: 2px solid var(--border-color); margin: 15px 0;">
                <div class="modal-detail-row" style="font-size: 1.1em; font-weight: bold; padding-bottom: 0; border-bottom: none;"><span>Net Worth (Bersih Aktif):</span> <strong id="summaryNetWorth">Rp 0</strong></div>
            </div>
        </div>

    </div>

    <div class="navigation">
        <div class="nav-item active" data-page="homePage">
            <span class="icon">üè†</span>
            <h4>Beranda</h4>
        </div>
        <div class="nav-item" data-page="piutangPage">
            <span class="icon">‚úÖ</span>
            <h4>Piutang</h4>
        </div>
        <div class="nav-item" data-page="formPage">
            <span class="icon" style="font-size: 2em; line-height: 1;">+</span>
        </div>
        <div class="nav-item" data-page="utangPage">
            <span class="icon">‚ùå</span>
            <h4>Utang</h4>
        </div>
        <div class="nav-item" data-page="historyPage">
            <span class="icon">üìú</span>
            <h4>Riwayat</h4>
        </div>
    </div>
    
    <div id="transactionDetailModal" style="
        display: none; 
        position: fixed; 
        z-index: 1000; 
        left: 0; 
        top: 0; 
        width: 100%; 
        height: 100%; 
        overflow: auto; 
        background-color: rgba(0,0,0,0.6); 
    ">
        <div style="
            background-color: var(--card-bg);
            margin: 10% auto; 
            padding: 20px;
            border: 1px solid #888;
            width: 90%; 
            max-width: 400px;
            border-radius: 12px;
            box-shadow: var(--shadow-elevation);
        ">
            <span onclick="closeDetailModal()" style="
                color: #aaa; 
                float: right; 
                font-size: 32px; 
                font-weight: bold;
                cursor: pointer;
            ">&times;</span>
            <h3 id="modalTitle" style="margin-top: 0; padding-bottom: 10px; border-bottom: 2px solid var(--border-color);">Detail Transaksi</h3>
            <div id="modalContent">
                </div>
            <div id="modalActions" style="margin-top: 15px;">
                </div>
        </div>
    </div>
    <script>
    let transactions = [];
    const form = document.getElementById('transactionForm');
    const piutangListContainer = document.getElementById('piutangList');
    const utangListContainer = document.getElementById('utangList');
    const historyListContainer = document.getElementById('historyList'); 
    const navItems = document.querySelectorAll('.nav-item');
    
    const principalInput = document.getElementById('principal');
    const interestRateInput = document.getElementById('interestRate');
    const installmentsCountInput = document.getElementById('installmentsCount');
    const startDateInput = document.getElementById('startDate'); 
    const finalDueDateDisplay = document.getElementById('finalDueDateDisplay'); 
    const estimateDiv = document.getElementById('installmentEstimate');

    let piutangChartInstance = null; 

    // ===================================
    // 1. MANAJEMEN DATA & LOCAL STORAGE
    // ===================================

    function loadTransactions() {
        const storedTransactions = localStorage.getItem('personalFinanceTracker');
        if (storedTransactions) {
            transactions = JSON.parse(storedTransactions); 
        }
    }

    function saveTransactions() {
        localStorage.setItem('personalFinanceTracker', JSON.stringify(transactions));
    }
    
    // ===================================
    // 2. FUNGSI UTILITAS
    // ===================================

    function formatInputRupiah(inputElement) {
        let angka = inputElement.value.replace(/\D/g, ''); 
        if (!angka || angka === '0') {
            inputElement.value = '';
            return;
        }
        let formatted = new Intl.NumberFormat('id-ID').format(angka);
        inputElement.value = formatted;
    }

    function formatCurrency(amount) {
        const roundedAmount = Math.round(parseFloat(amount)); 
        return roundedAmount.toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    }
    
    function cleanInterestRate(input) {
        return input.replace(/,/g, '.').replace(/[^0-9.]/g, ''); 
    }
    
    function cleanPrincipal(input) {
         return input.replace(/\./g, ''); 
    }

    function calculateTotal(principal, rate, installmentsCount) {
        const principalAmount = parseFloat(principal); 
        const interestRate = parseFloat(rate) / 100; 
        const installments = parseInt(installmentsCount);
        
        if (isNaN(principalAmount) || isNaN(interestRate) || isNaN(installments) || installments === 0) {
            return { totalInterest: 0, totalAmount: 0, totalPerInstallment: 0 };
        }
        
        const totalInterest = principalAmount * interestRate * installments;
        const totalAmount = principalAmount + totalInterest;
        const totalPerInstallment = totalAmount / installments;
        
        return {
            totalInterest: totalInterest,
            totalAmount: totalAmount,
            totalPerInstallment: totalPerInstallment,
        };
    }
    
    function getFinancialTotals() {
        let totalPiutangAwal = 0; 
        let sisaPiutang = 0;      
        let totalUtangAwal = 0;   
        let sisaUtang = 0;        

        const activeTransactions = transactions.filter(tx => tx.status === 'aktif');

        activeTransactions.forEach(tx => {
            const result = calculateTotal(tx.principal, tx.interestRate, tx.installmentsCount);
            const paidCount = tx.paymentHistory ? tx.paymentHistory.length : 0;
            const remainingInstallments = tx.installmentsCount - paidCount;
            const remainingTotal = result.totalPerInstallment * remainingInstallments;

            if (tx.type === 'piutang') {
                totalPiutangAwal += result.totalAmount; 
                sisaPiutang += remainingTotal;      
            } else if (tx.type === 'utang') {
                totalUtangAwal += result.totalAmount;   
                sisaUtang += remainingTotal;        
            }
        });
        
        const netWorthAwal = totalPiutangAwal - totalUtangAwal;
        const netWorthAkhir = sisaPiutang - sisaUtang;
        
        return {
            totalPiutangAwal, sisaPiutang, 
            totalUtangAwal, sisaUtang,
            netWorthAwal, netWorthAkhir
        };
    }
    
    function updateInstallmentEstimate() {
        const principalFormatted = principalInput.value;
        const principalClean = cleanPrincipal(principalFormatted); 
        const rateClean = cleanInterestRate(interestRateInput.value); 
        const installments = parseInt(installmentsCountInput.value);

        if (!principalClean || !rateClean || installments < 1) {
            estimateDiv.style.display = 'none';
            return;
        }

        const result = calculateTotal(principalClean, rateClean, installments);

        if (result.totalPerInstallment > 0) {
            estimateDiv.style.display = 'block';
            estimateDiv.innerHTML = `
                <p style="margin: 0; font-size: 0.9em; color:#0056b3;">
                    Estimasi Cicilan per Bulan (${installments}x): 
                    <strong style="font-size: 1.1em;">Rp ${formatCurrency(result.totalPerInstallment)}</strong>
                    <span style="font-size: 0.8em; color: #555;">(Total akhir: Rp ${formatCurrency(result.totalAmount)})</span>
                </p>
            `;
        } else {
             estimateDiv.style.display = 'none';
        }
    }
    
    function calculateDueDate() {
        const startDateValue = startDateInput.value;
        const installments = parseInt(installmentsCountInput.value);
        
        if (!startDateValue || installments < 1) {
            finalDueDateDisplay.textContent = 'Pilih tanggal mulai dan tenor/cicilan.';
            return '';
        }

        const startDate = new Date(startDateValue);
        if (isNaN(startDate)) {
            finalDueDateDisplay.textContent = 'Tanggal mulai tidak valid.';
            return '';
        }
        
        const finalDueDate = new Date(startDate);
        finalDueDate.setMonth(finalDueDate.getMonth() + installments); 

        const formattedDate = finalDueDate.toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });
        
        finalDueDateDisplay.textContent = formattedDate;
        
        return finalDueDate.toISOString().split('T')[0];
    }
    
    function calculateNextDueDate(tx) {
         const dateString = tx.startDate || tx.date;
         
         if (tx.status !== 'aktif' || !dateString) return null;

         const paidCount = tx.paymentHistory ? tx.paymentHistory.length : 0;
         if (paidCount >= tx.installmentsCount) return null; 

         const startDate = new Date(dateString); 
         
         // Hitung tanggal jatuh tempo cicilan berikutnya
         const nextDueDate = new Date(startDate.getFullYear(), startDate.getMonth() + paidCount + 1, startDate.getDate());

         return nextDueDate;
    }


    function calculateDelay(tx) {
        const nextDueDate = calculateNextDueDate(tx);

        if (!nextDueDate) return 0; // 0 jika sudah lunas

        const today = new Date();
        
        const todayDateOnly = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        const nextDueDateOnly = new Date(nextDueDate.getFullYear(), nextDueDate.getMonth(), nextDueDate.getDate());

        if (nextDueDateOnly < todayDateOnly) {
            const diffTime = Math.abs(todayDateOnly - nextDueDateOnly);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            return diffDays;
        }
        return 0; 
    }
    
    function getAvatarInitial(person) {
         return person.charAt(0).toUpperCase();
    }
    
    // ===================================
    // 3. FUNGSI EXPORT TO CSV
    // ===================================
    
    function exportToCSV() {
        if (transactions.length === 0) {
            alert("Tidak ada data transaksi untuk diexport.");
            return;
        }

        // Header CSV
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "Tipe,Pihak,Status,Tanggal Mulai,Tenor (Bulan),Jatuh Tempo Terakhir,Pokok (Rp),Suku Bunga (%),Total Akhir (Rp),Cicilan Per Bulan (Rp),Cicilan Dibayar,Sisa Saldo (Rp),Tanggal Lunas,Keterangan\n";

        transactions.forEach(tx => {
            const result = calculateTotal(tx.principal, tx.interestRate, tx.installmentsCount);
            const paidCount = tx.paymentHistory ? tx.paymentHistory.length : 0;
            const remainingInstallments = tx.installmentsCount - paidCount;
            const remainingTotal = result.totalPerInstallment * remainingInstallments;
            
            // Format tanggal akhir untuk export
            const finalDueDate = new Date(tx.startDate);
            finalDueDate.setMonth(finalDueDate.getMonth() + tx.installmentsCount); 
            const finalDueDateFormatted = finalDueDate.toLocaleDateString('id-ID');

            let keterangan = "";
            const delayDays = calculateDelay(tx);
            if (tx.status === 'aktif' && delayDays > 0) {
                keterangan = `Terlambat ${delayDays} hari`;
            } else if (tx.status === 'aktif' && remainingInstallments === tx.installmentsCount) {
                 keterangan = "Belum bayar";
            } else if (tx.status === 'lunas') {
                 keterangan = `Lunas pada ${new Date(tx.lunasDate).toLocaleDateString('id-ID')}`;
            }

            // Data Baris (Pastikan tidak ada koma di dalam data yang tidak dikutip)
            const row = [
                tx.type === 'piutang' ? 'Piutang' : 'Utang',
                `"${tx.person.replace(/"/g, '""')}"`, // Kuotasi dan escape nama
                tx.status,
                new Date(tx.startDate).toLocaleDateString('id-ID'),
                tx.installmentsCount,
                finalDueDateFormatted,
                parseFloat(tx.principal),
                parseFloat(tx.interestRate),
                Math.round(result.totalAmount),
                Math.round(result.totalPerInstallment),
                paidCount,
                Math.round(remainingTotal),
                tx.lunasDate ? new Date(tx.lunasDate).toLocaleDateString('id-ID') : '',
                keterangan
            ];

            csvContent += row.join(",") + "\n";
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "data_utang_piutang_" + new Date().toISOString().slice(0, 10) + ".csv");
        document.body.appendChild(link); 
        link.click(); 
        document.body.removeChild(link);
        alert("Data berhasil di-export ke CSV!");
    }


    // ===================================
    // 4. FUNGSI RENDER (TAMPILAN)
    // ===================================
    
    function renderBalanceSummary() {
         const { totalPiutangAwal, sisaPiutang, totalUtangAwal, sisaUtang, netWorthAkhir } = getFinancialTotals();
         
         // Update ringkasan di halaman summaryPage
         document.getElementById('summaryPiutangAwal').textContent = `Rp ${formatCurrency(totalPiutangAwal)}`;
         document.getElementById('summaryPiutangSisa').textContent = `Rp ${formatCurrency(sisaPiutang)}`;
         document.getElementById('summaryUtangAwal').textContent = `Rp ${formatCurrency(totalUtangAwal)}`;
         document.getElementById('summaryUtangSisa').textContent = `Rp ${formatCurrency(sisaUtang)}`;
         
         const netWorthElement = document.getElementById('summaryNetWorth');
         netWorthElement.textContent = `Rp ${formatCurrency(netWorthAkhir)}`;
         netWorthElement.style.color = netWorthAkhir >= 0 ? '#28a745' : '#dc3545';

         // Update dashboard di homePage
         const mainDashboard = document.getElementById('mainDashboard');
         mainDashboard.innerHTML = `
            <div class="summary-card card-piutang">
                <h3>Total Piutang Aktif</h3>
                <p>Rp ${formatCurrency(sisaPiutang)}</p>
                <p style="font-size:0.7em; margin-top: 3px; color: var(--text-muted);">(Awal: Rp ${formatCurrency(totalPiutangAwal)})</p>
            </div>
            <div class="summary-card card-utang">
                <h3>Total Utang Aktif</h3>
                <p>Rp ${formatCurrency(sisaUtang)}</p>
                <p style="font-size:0.7em; margin-top: 3px; color: var(--text-muted);">(Awal: Rp ${formatCurrency(totalUtangAwal)})</p>
            </div>
            <div class="summary-card card-networth">
                <h3>Net Worth (Bersih Aktif)</h3>
                <p style="color: ${netWorthAkhir >= 0 ? '#28a745' : '#dc3545'};">Rp ${formatCurrency(netWorthAkhir)}</p>
                <p style="font-size:0.7em; margin-top: 3px; color: var(--text-muted);">${netWorthAkhir >= 0 ? 'Positif' : 'Negatif'}</p>
            </div>
        `;
         renderPiutangChart(sisaPiutang, sisaUtang);
    }
    
    function renderLatestTransactions() {
        const container = document.getElementById('latestTransactions');
        container.innerHTML = '';
        
        // Gabungkan piutang dan utang, urutkan berdasarkan tanggal transaksi terbaru
        const latestTx = transactions.filter(tx => tx.status === 'aktif')
                                     .sort((a, b) => new Date(b.date) - new Date(a.date))
                                     .slice(0, 5); // Ambil 5 transaksi terbaru

        if (latestTx.length === 0) {
             container.innerHTML = `<p style="text-align: center; color: var(--text-muted); padding: 10px 0;">Tidak ada transaksi aktif.</p>`;
             return;
        }

        latestTx.forEach((tx) => {
            const index = transactions.indexOf(tx); 
            const result = calculateTotal(tx.principal, tx.interestRate, tx.installmentsCount);
            const paidCount = tx.paymentHistory ? tx.paymentHistory.length : 0;
            const remainingInstallments = tx.installmentsCount - paidCount;
            const remainingTotal = result.totalPerInstallment * remainingInstallments;
            const delayDays = calculateDelay(tx);
            const nextDueDate = calculateNextDueDate(tx);
            
            let statusText;
            let statusClass;
            let dueInfo;
            
            if (delayDays > 0) {
                statusText = 'Terlambat';
                statusClass = 'status-late';
                dueInfo = `Terlambat ${delayDays} hari`;
            } else if (remainingInstallments > 0 && nextDueDate) {
                const diffTime = Math.abs(nextDueDate - new Date());
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                
                statusText = 'Berjalan';
                statusClass = 'status-active';
                dueInfo = `Jatuh tempo dlm ${diffDays} hari`;
            } else {
                 statusText = 'Berjalan';
                 statusClass = 'status-active';
                 dueInfo = 'Menunggu cicilan pertama';
            }

            const listItem = document.createElement('div');
            listItem.classList.add('transaction-list-item', tx.type);
            listItem.onclick = () => showDetailModal(index); 

            listItem.innerHTML = `
                <div class="avatar-icon">${getAvatarInitial(tx.person)}</div>
                <div class="info-section">
                    <strong>${tx.person}</strong>
                    <p>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                        Cicilan ${paidCount}/${tx.installmentsCount}
                    </p>
                </div>
                <div class="amount-section">
                    <span class="remaining-amount">Rp ${formatCurrency(remainingTotal)}</span>
                    <p class="due-info">${dueInfo}</p>
                </div>
            `;
            container.appendChild(listItem);
        });
    }

    // FUNGSI SORTING
    function sortTransactions(txArray, sortKey) {
        const result = txArray.slice(); 

        if (sortKey === 'due_asc' || sortKey === 'due_desc') {
            result.sort((a, b) => {
                const nextDueA = calculateNextDueDate(a);
                const nextDueB = calculateNextDueDate(b);

                // Taruh yang sudah lunas/tidak ada jatuh tempo di akhir
                if (!nextDueA) return 1;
                if (!nextDueB) return -1;
                
                if (sortKey === 'due_asc') return nextDueA - nextDueB;
                return nextDueB - nextDueA;
            });
        } 
        
        else if (sortKey === 'amount_desc' || sortKey === 'amount_asc') {
            result.sort((a, b) => {
                const remainingA = calculateTotal(a.principal, a.interestRate, a.installmentsCount).totalPerInstallment * (a.installmentsCount - (a.paymentHistory ? a.paymentHistory.length : 0));
                const remainingB = calculateTotal(b.principal, b.interestRate, b.installmentsCount).totalPerInstallment * (b.installmentsCount - (b.paymentHistory ? b.paymentHistory.length : 0));

                if (sortKey === 'amount_asc') return remainingA - remainingB;
                return remainingB - remainingA;
            });
        }
        
        else if (sortKey === 'lunas_desc' || sortKey === 'lunas_asc') { 
            result.sort((a, b) => {
                const dateA = new Date(a.lunasDate);
                const dateB = new Date(b.lunasDate);
                if (sortKey === 'lunas_asc') return dateA - dateB;
                return dateB - dateA;
            });
        }

        else if (sortKey === 'principal_asc' || sortKey === 'principal_desc') { 
            result.sort((a, b) => {
                const principalA = parseFloat(a.principal);
                const principalB = parseFloat(b.principal);
                if (sortKey === 'principal_asc') return principalA - principalB;
                return principalB - principalA;
            });
        }
        
        return result;
    }


    // FUNGSI RENDER LIST UTAMA (Aktif)
    function renderTransactionList(type, container, searchTerm, sortKey) {
        container.innerHTML = ''; 
        
        let transactionsToDisplay = transactions.filter(tx => tx.type === type && tx.status === 'aktif');
        
        const lowerCaseSearchTerm = searchTerm.toLowerCase();
        if (lowerCaseSearchTerm) {
            transactionsToDisplay = transactionsToDisplay.filter(tx => 
                tx.person.toLowerCase().includes(lowerCaseSearchTerm)
            );
        }

        transactionsToDisplay = sortTransactions(transactionsToDisplay, sortKey);


        if (transactionsToDisplay.length === 0) {
            container.innerHTML = `<p style="text-align: center; color: var(--text-muted); padding: 10px 0;">${searchTerm ? `Tidak ditemukan transaksi '${type}' dengan nama "${searchTerm}".` : `Belum ada transaksi ${type} yang aktif dicatat.`}</p>`;
            return;
        }

        transactionsToDisplay.forEach((tx) => {
            const index = transactions.indexOf(tx); 
            const result = calculateTotal(tx.principal, tx.interestRate, tx.installmentsCount);
            
            const paidCount = tx.paymentHistory ? tx.paymentHistory.length : 0;
            const remainingInstallments = tx.installmentsCount - paidCount;
            const remainingTotal = result.totalPerInstallment * remainingInstallments;
            const delayDays = calculateDelay(tx);
            const nextDueDate = calculateNextDueDate(tx);
            
            let statusText;
            let statusClass;
            let dueInfo;
            
            if (delayDays > 0) {
                statusText = 'Terlambat';
                statusClass = 'status-late';
                dueInfo = `Jatuh tempo: ${delayDays} hari lalu`;
            } else if (remainingInstallments > 0 && nextDueDate) {
                const diffTime = Math.abs(nextDueDate - new Date());
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                
                statusText = 'Berjalan';
                statusClass = 'status-active';
                dueInfo = `Jatuh tempo dlm ${diffDays} hari`;
            } else {
                 statusText = 'Berjalan';
                 statusClass = 'status-active';
                 dueInfo = 'Lunas/Menunggu cicilan pertama';
            }


            const listItem = document.createElement('div');
            listItem.classList.add('transaction-list-item', tx.type);
            listItem.onclick = () => showDetailModal(index); 

            listItem.innerHTML = `
                <div class="avatar-icon">${getAvatarInitial(tx.person)}</div>
                <div class="info-section">
                    <strong>${tx.person}</strong>
                    <p>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                        Cicilan ${paidCount}/${tx.installmentsCount}
                    </p>
                </div>
                <div class="amount-section">
                    <span class="remaining-amount">Rp ${formatCurrency(remainingTotal)}</span>
                    <p class="due-info">${dueInfo}</p>
                </div>
            `;
            container.appendChild(listItem);
        });
    }
    
    // FUNGSI RENDER RIWAYAT LUNAS
    function renderHistoryList(searchTerm, sortKey) {
        historyListContainer.innerHTML = '';
        
        let historyTransactions = transactions.filter(tx => tx.status === 'lunas');
        
        const lowerCaseSearchTerm = searchTerm.toLowerCase();
        if (lowerCaseSearchTerm) {
            historyTransactions = historyTransactions.filter(tx => 
                tx.person.toLowerCase().includes(lowerCaseSearchTerm)
            );
        }

        historyTransactions = sortTransactions(historyTransactions, sortKey);

        if (historyTransactions.length === 0) {
            historyListContainer.innerHTML = `<p style="text-align: center; color: var(--text-muted); padding: 10px 0;">${searchTerm ? `Tidak ditemukan riwayat lunas dengan nama "${searchTerm}".` : `Belum ada riwayat transaksi lunas.`}</p>`;
            return;
        }
        
        historyTransactions.forEach(tx => {
            const index = transactions.indexOf(tx);
            const result = calculateTotal(tx.principal, tx.interestRate, tx.installmentsCount);
            const statusClass = tx.type === 'utang' ? 'utang' : 'piutang';
            const paidCount = tx.paymentHistory ? tx.paymentHistory.length : 0;
            
            const transactionDiv = document.createElement('div');
            transactionDiv.classList.add('transaction-list-item', statusClass); 
            transactionDiv.style.opacity = 0.85; 
            
            const formattedDate = new Date(tx.lunasDate).toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });

            transactionDiv.innerHTML = `
                <div class="avatar-icon" style="background-color: #e2e3e5; color: #6c757d;">L</div>
                <div class="info-section">
                    <strong>${tx.person} (${tx.type === 'utang' ? 'Utang' : 'Piutang'})</strong>
                    <p>
                        <span class="status-badge" style="background-color: #e2e3e5; color: #6c757d; font-weight: bold;">LUNAS</span>
                        Pokok: Rp ${formatCurrency(tx.principal)}
                    </p>
                </div>
                <div class="amount-section">
                    <span class="remaining-amount" style="color:var(--text-muted);">Rp ${formatCurrency(result.totalAmount)}</span>
                    <p class="due-info">${formattedDate}</p>
                    <button onclick="deleteTransaction(${index})" style="background-color: var(--danger-color); padding: 3px 6px; font-size: 0.7em; margin: 5px 0 0; display: block; float: right; width: auto;">Hapus</button>
                </div>
            `;
            historyListContainer.appendChild(transactionDiv);
        });
    }

    function filterTransactionList(pageType) {
        let container;
        let searchInput;
        let sortInput;
        let listType;

        if (pageType === 'piutang') {
            container = piutangListContainer;
            searchInput = document.getElementById('searchPiutang');
            sortInput = document.getElementById('sortPiutang');
            listType = 'piutang';
        } else if (pageType === 'utang') {
            container = utangListContainer;
            searchInput = document.getElementById('searchUtang');
            sortInput = document.getElementById('sortUtang');
            listType = 'utang';
        } else if (pageType === 'history') {
            container = historyListContainer;
            searchInput = document.getElementById('searchHistory');
            sortInput = document.getElementById('sortHistory');
            listType = 'history';
        } else {
            return;
        }

        const searchTerm = searchInput.value;
        const sortKey = sortInput.value;

        if (listType === 'history') {
            renderHistoryList(searchTerm, sortKey);
        } else {
            renderTransactionList(listType, container, searchTerm, sortKey);
        }
    }
    
    function renderPiutangChart(piutangAmount, utangAmount) {
        const ctx = document.getElementById('piutangChart').getContext('2d');
        if (piutangChartInstance) {
            piutangChartInstance.destroy();
        }
        
        piutangChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Sisa Piutang (Aktif)', 'Sisa Utang (Aktif)'],
                datasets: [{
                    data: [piutangAmount, utangAmount],
                    backgroundColor: ['#28a745', '#dc3545'],
                    borderWidth: 1
                }]
            },
            options: {
                 responsive: true,
                 maintainAspectRatio: false,
                 plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    tooltip: {
                         callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed !== null) {
                                    label += 'Rp ' + formatCurrency(context.parsed);
                                }
                                return label;
                            }
                        }
                    },
                    datalabels: {
                        formatter: (value) => {
                            // Tampilkan hanya jika nilainya signifikan
                            if (value > 0) {
                                return 'Rp ' + formatCurrency(value);
                            } else {
                                return '';
                            }
                        },
                        color: '#fff', // Warna teks putih untuk kontras
                        font: {
                            weight: 'bold',
                            size: 10
                        },
                        textShadow: '1px 1px 2px rgba(0,0,0,0.5)' // Tambahkan shadow agar terlihat jelas
                    }
                }
            },
            plugins: [ChartDataLabels]
        });
    }

    // ===================================
    // 5. MANAJEMEN APLIKASI (Logic & Modal)
    // ===================================

    function closeDetailModal() {
        document.getElementById('transactionDetailModal').style.display = 'none';
    }

    function showDetailModal(index) {
        const tx = transactions[index];
        const result = calculateTotal(tx.principal, tx.interestRate, tx.installmentsCount);
        const paidCount = tx.paymentHistory ? tx.paymentHistory.length : 0;
        const remainingInstallments = tx.installmentsCount - paidCount;
        const remainingTotal = result.totalPerInstallment * remainingInstallments;
        
        const finalDueDate = new Date(tx.startDate);
        finalDueDate.setMonth(finalDueDate.getMonth() + tx.installmentsCount); 
        
        const formattedFinalDueDate = finalDueDate.toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });
        
        const delayDays = calculateDelay(tx);
        const delayIndicator = delayDays > 0 ? `<span class="status-badge status-late" style="margin-left: 10px;">Terlambat ${delayDays} hari</span>` : '';
        
        let paymentHistoryHTML = '';
        if (paidCount > 0) {
            paymentHistoryHTML += '<h4 style="border-bottom: 1px solid var(--border-color); padding-bottom: 5px; margin-top: 15px; font-size: 1em;">Riwayat Pembayaran</h4>';
            paymentHistoryHTML += '<div class="payment-history-list">';
            tx.paymentHistory.forEach((payment, idx) => {
                const formattedPaymentDate = new Date(payment.date).toLocaleDateString('id-ID');
                const isLast = idx === paidCount - 1 && tx.status === 'aktif';
                paymentHistoryHTML += `
                    <div style="color: var(--text-dark);">
                        <span>Cicilan ke-${idx + 1} (${formattedPaymentDate})</span>
                        ${isLast ? `<button onclick="undoPayment(${index}); closeDetailModal()" style="background-color: var(--warning-color); color: var(--text-dark); padding: 3px 6px; font-size: 0.7em; margin: 0; width: auto;">Batalkan</button>` : ''}
                    </div>
                `;
            });
            paymentHistoryHTML += '</div>';
        }

        document.getElementById('modalTitle').innerHTML = `${tx.type === 'utang' ? 'UTANG' : 'PIUTANG'} dari ${tx.person} ${delayIndicator}`;
        document.getElementById('modalContent').innerHTML = `
            <div class="modal-detail-row">
                <span>Pokok Pinjaman:</span>
                <strong>Rp ${formatCurrency(tx.principal)}</strong>
            </div>
            <div class="modal-detail-row">
                <span>Suku Bunga (${tx.interestRate}%/bln):</span>
                <strong>Rp ${formatCurrency(result.totalInterest)}</strong>
            </div>
            <div class="modal-detail-row" style="margin-top: 10px; font-size: 1.1em; font-weight: bold; border-top: 1px solid var(--border-color);">
                <span>TOTAL AKHIR:</span>
                <strong>Rp ${formatCurrency(result.totalAmount)}</strong>
            </div>
            <div style="border-top: 1px dashed #ccc; margin: 10px 0;"></div>
            <div class="modal-detail-row">
                <span>Tanggal Mulai:</span>
                <strong>${new Date(tx.startDate).toLocaleDateString('id-ID')}</strong>
            </div>
            <div class="modal-detail-row">
                <span>Jatuh Tempo Terakhir:</span>
                <strong>${formattedFinalDueDate}</strong>
            </div>
            <div class="modal-detail-row">
                <span>Cicilan per Bulan (${tx.installmentsCount}x):</span>
                <strong>Rp ${formatCurrency(result.totalPerInstallment)}</strong>
            </div>
            <div class="modal-detail-row">
                <span>Telah Dibayar:</span>
                <strong>${paidCount} dari ${tx.installmentsCount} cicilan</strong>
            </div>
            <div class="modal-detail-row">
                <span>Sisa Pembayaran:</span>
                <strong style="color: ${remainingTotal > 0 ? 'var(--danger-color)' : 'var(--success-color)'};">Rp ${formatCurrency(remainingTotal)} (${remainingInstallments} cicilan)</strong>
            </div>
            ${paymentHistoryHTML}
        `;
        
        // Hapus semua tombol aksi lama
        document.getElementById('modalActions').innerHTML = '';

        if (tx.status === 'aktif') {
            if (remainingInstallments > 0) {
                 // Tombol Bayar Cicilan
                 const payButton = document.createElement('button');
                 payButton.textContent = `Bayar Cicilan ke ${paidCount + 1}`;
                 payButton.style.backgroundColor = tx.type === 'piutang' ? 'var(--success-color)' : 'var(--primary-color)';
                 payButton.onclick = () => { payInstallment(index); closeDetailModal(); };
                 document.getElementById('modalActions').appendChild(payButton);
            }
            
            // Tombol Lunaskan
            const markPaidButton = document.createElement('button');
            markPaidButton.textContent = `Lunaskan Sisa Saldo`;
            markPaidButton.style.backgroundColor = 'var(--warning-color)';
            markPaidButton.style.color = 'var(--text-dark)';
            markPaidButton.onclick = () => { markPaid(index); closeDetailModal(); };
            document.getElementById('modalActions').appendChild(markPaidButton);
            
            // Tombol Hapus (hanya untuk transaksi aktif, untuk riwayat dihapus di halaman History)
            const deleteButton = document.createElement('button');
            deleteButton.textContent = `Hapus Transaksi Aktif`;
            deleteButton.style.backgroundColor = 'var(--danger-color)';
            deleteButton.onclick = () => { deleteTransaction(index); closeDetailModal(); };
            document.getElementById('modalActions').appendChild(deleteButton);
        }


        document.getElementById('transactionDetailModal').style.display = 'block';
    }


    function payInstallment(index) {
        const tx = transactions[index];
        if (!tx.paymentHistory) tx.paymentHistory = [];
        
        const paidCount = tx.paymentHistory.length;
        
        if (paidCount < tx.installmentsCount) {
            const nextInstallmentNumber = paidCount + 1;
            tx.paymentHistory.push({
                installment: nextInstallmentNumber,
                date: new Date().toISOString().slice(0, 10)
            });
            
            alert(`Cicilan ke-${nextInstallmentNumber} untuk ${tx.person} berhasil dibayar.`);
            
            if(tx.paymentHistory.length === tx.installmentsCount) {
                tx.status = 'lunas';
                tx.lunasDate = new Date().toISOString().slice(0, 10);
                alert(`Selamat! Transaksi ${tx.person} telah lunas penuh!`);
            }
            
            saveTransactions();
            refreshAllPagesAndCurrentView();
        } else {
            alert(`Semua cicilan untuk ${tx.person} sudah lunas.`);
        }
    }

    function undoPayment(index) {
        const tx = transactions[index];
        if (!tx.paymentHistory || tx.paymentHistory.length === 0) {
            alert("Tidak ada pembayaran yang bisa dibatalkan.");
            return;
        }

        if (confirm(`Apakah Anda yakin ingin membatalkan pembayaran cicilan terakhir (ke-${tx.paymentHistory.length}) untuk ${tx.person}?`)) {
            tx.paymentHistory.pop(); 

            if (tx.status === 'lunas') {
                tx.status = 'aktif';
                tx.lunasDate = null;
            }
            
            saveTransactions();
            alert(`Pembayaran cicilan terakhir untuk ${tx.person} berhasil dibatalkan.`);
            refreshAllPagesAndCurrentView();
        }
    }


    function markPaid(index) {
        if (confirm(`Apakah Anda yakin ingin menandai transaksi ${transactions[index].person} lunas penuh? Ini akan mencatat semua sisa cicilan sebagai sudah dibayar.`)) {
            const tx = transactions[index];
            if (!tx.paymentHistory) tx.paymentHistory = [];
            const paidCount = tx.paymentHistory.length;
            const remaining = tx.installmentsCount - paidCount;
            
            if (remaining > 0) {
                 for (let i = 0; i < remaining; i++) {
                      tx.paymentHistory.push({
                         installment: paidCount + i + 1,
                         date: new Date().toISOString().slice(0, 10) 
                      });
                 }
            }


            tx.status = 'lunas';
            tx.lunasDate = new Date().toISOString().slice(0, 10); 
            saveTransactions();
            alert(`Transaksi ${tx.person} berhasil ditandai Lunas Penuh dan dipindahkan ke Riwayat!`);
            refreshAllPagesAndCurrentView();
        }
    }
    
    function deleteTransaction(index) {
        if (confirm(`Apakah Anda yakin ingin MENGHAPUS PERMANEN riwayat transaksi ${transactions[index].person}? Tindakan ini tidak dapat dibatalkan.`)) {
            transactions.splice(index, 1);
            saveTransactions();
            alert("Riwayat transaksi berhasil dihapus.");
            refreshAllPagesAndCurrentView();
        }
    }

    form.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const calculatedDueDate = calculateDueDate();

        if (!calculatedDueDate) {
            alert("Harap lengkapi Tanggal Mulai dan Tenor/Cicilan.");
            return;
        }

        const principalFormatted = principalInput.value;
        const principalClean = cleanPrincipal(principalFormatted); 
        const interestRateClean = cleanInterestRate(interestRateInput.value);

        const newTransaction = {
            id: Date.now(), // Tambahkan ID unik
            type: document.getElementById('type').value,
            person: document.getElementById('person').value,
            principal: principalClean, 
            interestRate: interestRateClean, 
            installmentsCount: parseInt(installmentsCountInput.value), 
            
            startDate: startDateInput.value, 
            date: new Date().toISOString().slice(0, 10), 
            
            status: 'aktif', 
            lunasDate: null,
            paymentHistory: [] 
        };
        
        if (!newTransaction.principal || parseFloat(newTransaction.principal) < 1 || newTransaction.installmentsCount < 1) {
            alert("Jumlah Pokok dan Jumlah Cicilan harus valid.");
            return;
        }
        
        if (isNaN(parseFloat(newTransaction.interestRate))) {
             alert("Suku Bunga tidak valid.");
             return;
        }

        transactions.push(newTransaction);
        saveTransactions(); 
        form.reset(); 
        estimateDiv.style.display = 'none';
        finalDueDateDisplay.textContent = 'Pilih tanggal mulai dan tenor/cicilan.'; 
        alert("Transaksi berhasil dicatat!");
        refreshAllPagesAndCurrentView();
        showPage('homePage'); 
    });
    
    // ===================================
    // 6. MANAJEMEN MULTI-PAGE & INIT
    // ===================================
    
    function showPage(pageId) {
        const pages = document.querySelectorAll('.page');
        const currentNav = document.querySelector(`.nav-item[data-page="${pageId}"]`);

        pages.forEach(page => page.classList.remove('active'));
        navItems.forEach(nav => nav.classList.remove('active'));

        document.getElementById(pageId).classList.add('active');
        if (currentNav) {
            currentNav.classList.add('active');
        }

        if (pageId === 'homePage') {
            renderBalanceSummary(); 
            renderLatestTransactions(); 
        } else if (pageId === 'piutangPage') {
            document.getElementById('searchPiutang').value = ''; 
            document.getElementById('sortPiutang').value = 'due_asc'; 
            filterTransactionList('piutang');
        } else if (pageId === 'utangPage') {
            document.getElementById('searchUtang').value = ''; 
            document.getElementById('sortUtang').value = 'due_asc'; 
            filterTransactionList('utang');
        } else if (pageId === 'historyPage') { 
            document.getElementById('searchHistory').value = ''; 
            document.getElementById('sortHistory').value = 'lunas_desc'; 
            filterTransactionList('history');
        } else if (pageId === 'summaryPage') {
             renderBalanceSummary(); 
        }
        
        // Atur ulang scroll ke atas saat navigasi
        document.querySelector('.container').scrollTop = 0;
        
        if (pageId !== 'formPage') {
            estimateDiv && (estimateDiv.style.display = 'none');
        } else {
             // Set tanggal hari ini sebagai default di form
             const today = new Date().toISOString().split('T')[0];
             startDateInput.value = today;
             document.getElementById('finalDueDateDisplay').textContent = 'Pilih tanggal mulai dan tenor/cicilan.'; 
             updateInstallmentEstimate();
             calculateDueDate();
        }
    }

    navItems.forEach(item => {
        item.addEventListener('click', () => {
            const pageId = item.getAttribute('data-page');
            showPage(pageId);
        });
    });

    function refreshAllPagesAndCurrentView() {
        const activePageElement = document.querySelector('.page.active');
        if (activePageElement) {
             const activePageId = activePageElement.id;
             showPage(activePageId); 
        } else {
             showPage('homePage');
        }
    }
    
    // INISIALISASI APLIKASI
    loadTransactions(); 
    // Data Migration (Jika ada data lama tanpa status/paymentHistory)
    transactions.forEach(tx => {
        if (!tx.id) tx.id = Date.now() + Math.floor(Math.random() * 1000); 
        if (!tx.status) {
            tx.status = 'aktif';
            tx.lunasDate = null;
        }
        if (tx.paidInstallments !== undefined) {
             if (!tx.paymentHistory) tx.paymentHistory = [];
             while(tx.paymentHistory.length < tx.paidInstallments) {
                 tx.paymentHistory.push({
                     installment: tx.paymentHistory.length + 1,
                     date: tx.date 
                 });
             }
             delete tx.paidInstallments; 
        }
        if (!tx.paymentHistory) tx.paymentHistory = []; 
        
        if (!tx.startDate && tx.dueDate) {
             tx.startDate = tx.date; 
             delete tx.dueDate; 
        }
        if (!tx.startDate && tx.date) {
             tx.startDate = tx.date;
        }
    });
    saveTransactions();
    showPage('homePage'); 
    
    // Bind fungsi ke window
    window.showDetailModal = showDetailModal;
    window.closeDetailModal = closeDetailModal;
    window.payInstallment = payInstallment;
    window.undoPayment = undoPayment;
    window.markPaid = markPaid;
    window.deleteTransaction = deleteTransaction;
    window.filterTransactionList = filterTransactionList;
    window.exportToCSV = exportToCSV;
    window.formatInputRupiah = formatInputRupiah;
    window.updateInstallmentEstimate = updateInstallmentEstimate;
    window.calculateDueDate = calculateDueDate;
</script>

</body>
</html>
